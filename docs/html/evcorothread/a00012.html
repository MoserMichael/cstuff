<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Simple coroutine library integrated with IO event loop (libevent) / objects in plain C: EVSOCKET</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Simple coroutine library integrated with IO event loop (libevent) / objects in plain C&#160;<span id="projectnumber">Snapshot</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#nested-classes">Classes</a> &#124;
<a href="#typedef-members">Typedefs</a> &#124;
<a href="#enum-members">Enumerations</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">EVSOCKET</div>  </div>
</div>
<div class="contents">

<p>a socket attached to user mode thread.  
<a href="#details">More...</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="nested-classes"></a>
Classes</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00002.html">tagEVSOCKET</a></td></tr>
<tr><td colspan="2"><h2><a name="typedef-members"></a>
Typedefs</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="a00002.html">tagEVSOCKET</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00012.html#gaa657a3b712a0f84e9b7aeff7059d96a0">EVSOCKET</a></td></tr>
<tr><td colspan="2"><h2><a name="enum-members"></a>
Enumerations</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">enum &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00012.html#ga2c41f6288c8bc944dd898419b7fbbb0c">EVSOCKET_STATE</a> { <br/>
&#160;&#160;<a class="el" href="a00012.html#gga2c41f6288c8bc944dd898419b7fbbb0ca58af0fd1980fbcf50615f79a5f5e1bb5">EVSOCKET_STATE_INIT</a>, 
<a class="el" href="a00012.html#gga2c41f6288c8bc944dd898419b7fbbb0ca6fb24f7071ea4cae87a9fa24583dbff0">EVSOCKET_STATE_CONNECTING</a>, 
<a class="el" href="a00012.html#gga2c41f6288c8bc944dd898419b7fbbb0caf309c7d0adb12a6b6c2db8568b2360a1">EVSOCKET_STATE_CONNECTED</a>, 
<a class="el" href="a00012.html#gga2c41f6288c8bc944dd898419b7fbbb0ca11d241b716a59cdbc6c07458fbefede5">EVSOCKET_STATE_READING</a>, 
<br/>
&#160;&#160;<a class="el" href="a00012.html#gga2c41f6288c8bc944dd898419b7fbbb0ca488819d6df0a5d336bec468b8e0ab8cf">EVSOCKET_STATE_WRITING</a>, 
<a class="el" href="a00012.html#gga2c41f6288c8bc944dd898419b7fbbb0ca409d2782e34636815d4b096daa659f07">EVSOCKET_STATE_CLOSED</a>, 
<a class="el" href="a00012.html#gga2c41f6288c8bc944dd898419b7fbbb0ca9a409c3600e382e41ace36599966aec7">EVSOCKET_STATE_ERROR</a>
<br/>
 }</td></tr>
<tr><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="a00002.html">EVSOCKET</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00012.html#ga2fd5da1f97d6ab55cc7c977d5759558e">EVSOCKET_init</a> (<a class="el" href="a00003.html">EVTHREAD</a> *thread, int fd, int is_connected)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00012.html#ga152040d20eb847259e1a5b129d08280d">EVSOCKET_close</a> (<a class="el" href="a00002.html">EVSOCKET</a> *socket)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00012.html#ga9611ce37f2fb0b914d624fcfeaf14045">EVSOCKET_connect</a> (<a class="el" href="a00002.html">EVSOCKET</a> *socket, struct sockaddr *address, socklen_t socklen, struct timeval timeout)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00012.html#ga9f1eadc43b53273402e301cbecd5af2f">EVSOCKET_set_idle_timeout</a> (<a class="el" href="a00002.html">EVSOCKET</a> *socket, struct timeval timeout)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00012.html#ga2400bf324d24d3d0b011f32c7eceecda">EVSOCKET_recv</a> (<a class="el" href="a00002.html">EVSOCKET</a> *socket, void *buf, size_t buf_size, int flags, struct timeval timeout)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00012.html#gae70737035f6cd136a85b6b24e31fe8be">EVSOCKET_recv_all</a> (<a class="el" href="a00002.html">EVSOCKET</a> *socket, void *buf, size_t buf_size, int flags, struct timeval timeout)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00012.html#ga6c9dc88bb3fbe603473bc694664cdc7d">EVSOCKET_send</a> (<a class="el" href="a00002.html">EVSOCKET</a> *socket, void *buf, size_t buf_size, int flags, struct timeval timeout)</td></tr>
</table>
<hr/><a name="details" id="details"></a><h2>Detailed Description</h2>
<p>a socket attached to user mode thread. </p>
<ul>
<li>a thread can either read from or write to a socket, not both at the same time.</li>
<li>a thread can read or write from one socket at a time. </li>
</ul>
<hr/><h2>Typedef Documentation</h2>
<a class="anchor" id="gaa657a3b712a0f84e9b7aeff7059d96a0"></a><!-- doxytag: member="evthread.h::EVSOCKET" ref="gaa657a3b712a0f84e9b7aeff7059d96a0" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="a00002.html">tagEVSOCKET</a> 
   <a class="el" href="a00002.html">EVSOCKET</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<hr/><h2>Enumeration Type Documentation</h2>
<a class="anchor" id="ga2c41f6288c8bc944dd898419b7fbbb0c"></a><!-- doxytag: member="evthread.h::EVSOCKET_STATE" ref="ga2c41f6288c8bc944dd898419b7fbbb0c" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">enum <a class="el" href="a00012.html#ga2c41f6288c8bc944dd898419b7fbbb0c">EVSOCKET_STATE</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<dl><dt><b>Enumerator: </b></dt><dd><table border="0" cellspacing="2" cellpadding="0">
<tr><td valign="top"><em><a class="anchor" id="gga2c41f6288c8bc944dd898419b7fbbb0ca58af0fd1980fbcf50615f79a5f5e1bb5"></a><!-- doxytag: member="EVSOCKET_STATE_INIT" ref="gga2c41f6288c8bc944dd898419b7fbbb0ca58af0fd1980fbcf50615f79a5f5e1bb5" args="" -->EVSOCKET_STATE_INIT</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="gga2c41f6288c8bc944dd898419b7fbbb0ca6fb24f7071ea4cae87a9fa24583dbff0"></a><!-- doxytag: member="EVSOCKET_STATE_CONNECTING" ref="gga2c41f6288c8bc944dd898419b7fbbb0ca6fb24f7071ea4cae87a9fa24583dbff0" args="" -->EVSOCKET_STATE_CONNECTING</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="gga2c41f6288c8bc944dd898419b7fbbb0caf309c7d0adb12a6b6c2db8568b2360a1"></a><!-- doxytag: member="EVSOCKET_STATE_CONNECTED" ref="gga2c41f6288c8bc944dd898419b7fbbb0caf309c7d0adb12a6b6c2db8568b2360a1" args="" -->EVSOCKET_STATE_CONNECTED</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="gga2c41f6288c8bc944dd898419b7fbbb0ca11d241b716a59cdbc6c07458fbefede5"></a><!-- doxytag: member="EVSOCKET_STATE_READING" ref="gga2c41f6288c8bc944dd898419b7fbbb0ca11d241b716a59cdbc6c07458fbefede5" args="" -->EVSOCKET_STATE_READING</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="gga2c41f6288c8bc944dd898419b7fbbb0ca488819d6df0a5d336bec468b8e0ab8cf"></a><!-- doxytag: member="EVSOCKET_STATE_WRITING" ref="gga2c41f6288c8bc944dd898419b7fbbb0ca488819d6df0a5d336bec468b8e0ab8cf" args="" -->EVSOCKET_STATE_WRITING</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="gga2c41f6288c8bc944dd898419b7fbbb0ca409d2782e34636815d4b096daa659f07"></a><!-- doxytag: member="EVSOCKET_STATE_CLOSED" ref="gga2c41f6288c8bc944dd898419b7fbbb0ca409d2782e34636815d4b096daa659f07" args="" -->EVSOCKET_STATE_CLOSED</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="gga2c41f6288c8bc944dd898419b7fbbb0ca9a409c3600e382e41ace36599966aec7"></a><!-- doxytag: member="EVSOCKET_STATE_ERROR" ref="gga2c41f6288c8bc944dd898419b7fbbb0ca9a409c3600e382e41ace36599966aec7" args="" -->EVSOCKET_STATE_ERROR</em>&nbsp;</td><td>
</td></tr>
</table>
</dd>
</dl>

<p>Definition at line <a class="el" href="a00008_source.html#l00186">186</a> of file <a class="el" href="a00008_source.html">evthread.h</a>.</p>
<div class="fragment"><pre class="fragment">             {
  <a class="code" href="a00012.html#gga2c41f6288c8bc944dd898419b7fbbb0ca58af0fd1980fbcf50615f79a5f5e1bb5">EVSOCKET_STATE_INIT</a>,
  <a class="code" href="a00012.html#gga2c41f6288c8bc944dd898419b7fbbb0ca6fb24f7071ea4cae87a9fa24583dbff0">EVSOCKET_STATE_CONNECTING</a>,
  <a class="code" href="a00012.html#gga2c41f6288c8bc944dd898419b7fbbb0caf309c7d0adb12a6b6c2db8568b2360a1">EVSOCKET_STATE_CONNECTED</a>,
  <a class="code" href="a00012.html#gga2c41f6288c8bc944dd898419b7fbbb0ca11d241b716a59cdbc6c07458fbefede5">EVSOCKET_STATE_READING</a>,
  <a class="code" href="a00012.html#gga2c41f6288c8bc944dd898419b7fbbb0ca488819d6df0a5d336bec468b8e0ab8cf">EVSOCKET_STATE_WRITING</a>,
  <a class="code" href="a00012.html#gga2c41f6288c8bc944dd898419b7fbbb0ca409d2782e34636815d4b096daa659f07">EVSOCKET_STATE_CLOSED</a>,
  <a class="code" href="a00012.html#gga2c41f6288c8bc944dd898419b7fbbb0ca9a409c3600e382e41ace36599966aec7">EVSOCKET_STATE_ERROR</a>,
} <a class="code" href="a00012.html#ga2c41f6288c8bc944dd898419b7fbbb0c">EVSOCKET_STATE</a>;
</pre></div>
</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="ga152040d20eb847259e1a5b129d08280d"></a><!-- doxytag: member="evthread.h::EVSOCKET_close" ref="ga152040d20eb847259e1a5b129d08280d" args="(EVSOCKET *socket)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int EVSOCKET_close </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00002.html">EVSOCKET</a> *&#160;</td>
          <td class="paramname"><em>socket</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="a00007_source.html#l00313">313</a> of file <a class="el" href="a00007_source.html">evthread.c</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> rt;

  <span class="keywordflow">if</span> (socket-&gt;<a class="code" href="a00002.html#a25d6aeb264edc059926e412bbf0d8900">timer_idle_timeout</a>) {
    <a class="code" href="a00011.html#ga69cdac6c1ab58a63245fb14dfb43cc70">EVTIMER_free</a>( socket-&gt;<a class="code" href="a00002.html#a25d6aeb264edc059926e412bbf0d8900">timer_idle_timeout</a> );
  }
  <span class="keywordflow">if</span> (socket-&gt;<a class="code" href="a00002.html#ad73f5d6d015fd3f464b9e6c1894e9836">timer_io_timeout</a>) {
    <a class="code" href="a00011.html#ga69cdac6c1ab58a63245fb14dfb43cc70">EVTIMER_free</a>( socket-&gt;<a class="code" href="a00002.html#ad73f5d6d015fd3f464b9e6c1894e9836">timer_io_timeout</a>);  
  }

  event_del( &amp;socket-&gt;<a class="code" href="a00002.html#a424a834569ee2593b2d04b6e6ae9799b">read_event</a> );   
  event_del( &amp;socket-&gt;<a class="code" href="a00002.html#a25b5c3a94163a89a7bc0dff0dbdeb277">write_event</a> );   
  
  <span class="keywordflow">do</span> {
    rt = close(socket-&gt;<a class="code" href="a00002.html#ac4f60cb252957d83ab97420d9ba75a7f">fd</a>);
  } <span class="keywordflow">while</span>(rt == -1 &amp;&amp; errno == EINTR);
  

  <a class="code" href="a00007.html#afac4b846bbebc9e8bb60ec8c4d527eac">EVTHREAD_OBJECT_free</a>( &amp;socket-&gt;<a class="code" href="a00002.html#aa2f8699d28dc94e1acadc99a1d0aab2a">object_base</a> );
  <span class="keywordflow">return</span> rt;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ga9611ce37f2fb0b914d624fcfeaf14045"></a><!-- doxytag: member="evthread.h::EVSOCKET_connect" ref="ga9611ce37f2fb0b914d624fcfeaf14045" args="(EVSOCKET *socket, struct sockaddr *address, socklen_t socklen, struct timeval timeout)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int EVSOCKET_connect </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00002.html">EVSOCKET</a> *&#160;</td>
          <td class="paramname"><em>socket</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct sockaddr *&#160;</td>
          <td class="paramname"><em>address</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">socklen_t&#160;</td>
          <td class="paramname"><em>socklen</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct timeval&#160;</td>
          <td class="paramname"><em>timeout</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="a00007_source.html#l00380">380</a> of file <a class="el" href="a00007_source.html">evthread.c</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> rt;

  <span class="keywordflow">if</span> (socket-&gt;<a class="code" href="a00002.html#a8841e3dec607bf1eaeee342eda681adb">state</a> != <a class="code" href="a00012.html#gga2c41f6288c8bc944dd898419b7fbbb0ca58af0fd1980fbcf50615f79a5f5e1bb5">EVSOCKET_STATE_INIT</a>) {
    <span class="keywordflow">return</span> -1;
  }

  <span class="keywordflow">do</span> {
    rt = connect( socket-&gt;<a class="code" href="a00002.html#ac4f60cb252957d83ab97420d9ba75a7f">fd</a>, address, socklen );
  } <span class="keywordflow">while</span> (rt == -1 &amp;&amp; errno == EINTR);
 
  <span class="keywordflow">if</span> (rt == 0) {
     socket-&gt;<a class="code" href="a00002.html#a8841e3dec607bf1eaeee342eda681adb">state</a> = <a class="code" href="a00012.html#gga2c41f6288c8bc944dd898419b7fbbb0caf309c7d0adb12a6b6c2db8568b2360a1">EVSOCKET_STATE_CONNECTED</a>;
     <span class="keywordflow">return</span> 0;
  }
  <span class="keywordflow">if</span> (rt == -1 &amp;&amp; errno == EINPROGRESS) {
 
     socket-&gt;<a class="code" href="a00002.html#a8841e3dec607bf1eaeee342eda681adb">state</a> = <a class="code" href="a00012.html#gga2c41f6288c8bc944dd898419b7fbbb0ca6fb24f7071ea4cae87a9fa24583dbff0">EVSOCKET_STATE_CONNECTING</a>;

     socket-&gt;<a class="code" href="a00002.html#ad73f5d6d015fd3f464b9e6c1894e9836">timer_io_timeout</a> = <a class="code" href="a00011.html#gaa7702b36f1620f2526f4e57e7f4f90f4">EVTIMER_init_one_shot</a>( socket-&gt;<a class="code" href="a00002.html#ac7bd1c84d925b7c459220750b47d3d09">thread</a>, 1, timeout, <a class="code" href="a00007.html#a263766876e9dd593e9f37a825aa6bd3f">io_timeout_proc</a>, socket);

     event_add( &amp;socket-&gt;<a class="code" href="a00002.html#a25b5c3a94163a89a7bc0dff0dbdeb277">write_event</a>, 0 );
     
     CTHREAD_yield( 0, 0);

     <span class="keywordflow">if</span> (socket-&gt;<a class="code" href="a00002.html#ad73f5d6d015fd3f464b9e6c1894e9836">timer_io_timeout</a>) {
       <a class="code" href="a00011.html#ga69cdac6c1ab58a63245fb14dfb43cc70">EVTIMER_free</a>( socket-&gt;<a class="code" href="a00002.html#ad73f5d6d015fd3f464b9e6c1894e9836">timer_io_timeout</a> ); 
       socket-&gt;<a class="code" href="a00002.html#ad73f5d6d015fd3f464b9e6c1894e9836">timer_io_timeout</a> = 0; 
     }

     <span class="keywordflow">if</span> (socket-&gt;<a class="code" href="a00002.html#a8841e3dec607bf1eaeee342eda681adb">state</a> == <a class="code" href="a00012.html#gga2c41f6288c8bc944dd898419b7fbbb0caf309c7d0adb12a6b6c2db8568b2360a1">EVSOCKET_STATE_CONNECTED</a>) {
       <span class="keywordflow">return</span> 0;
     }
  } 
  <span class="keywordflow">return</span> -1;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ga2fd5da1f97d6ab55cc7c977d5759558e"></a><!-- doxytag: member="evthread.h::EVSOCKET_init" ref="ga2fd5da1f97d6ab55cc7c977d5759558e" args="(EVTHREAD *thread, int fd, int is_connected)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="a00002.html">EVSOCKET</a>* EVSOCKET_init </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00003.html">EVTHREAD</a> *&#160;</td>
          <td class="paramname"><em>thread</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>fd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>is_connected</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="a00007_source.html#l00278">278</a> of file <a class="el" href="a00007_source.html">evthread.c</a>.</p>
<div class="fragment"><pre class="fragment">{
  <a class="code" href="a00002.html">EVSOCKET</a> *socket;

  socket = (<a class="code" href="a00002.html">EVSOCKET</a> *) malloc( <span class="keyword">sizeof</span>( <a class="code" href="a00002.html">EVSOCKET</a> ) );
  <span class="keywordflow">if</span> (!socket) {
    <span class="keywordflow">return</span> 0;
  }


  socket-&gt;<a class="code" href="a00002.html#ac4f60cb252957d83ab97420d9ba75a7f">fd</a> = fd;
  socket-&gt;<a class="code" href="a00002.html#a25d6aeb264edc059926e412bbf0d8900">timer_idle_timeout</a> = 0;
  socket-&gt;<a class="code" href="a00002.html#ad73f5d6d015fd3f464b9e6c1894e9836">timer_io_timeout</a> = 0;
  socket-&gt;<a class="code" href="a00002.html#a8841e3dec607bf1eaeee342eda681adb">state</a> = is_connected ? <a class="code" href="a00012.html#gga2c41f6288c8bc944dd898419b7fbbb0caf309c7d0adb12a6b6c2db8568b2360a1">EVSOCKET_STATE_CONNECTED</a> : <a class="code" href="a00012.html#gga2c41f6288c8bc944dd898419b7fbbb0ca58af0fd1980fbcf50615f79a5f5e1bb5">EVSOCKET_STATE_INIT</a>; 
  
  socket-&gt;<a class="code" href="a00002.html#ac7bd1c84d925b7c459220750b47d3d09">thread</a> = thread;
  socket-&gt;<a class="code" href="a00002.html#ab7a9905daf7aa5dc109ac87e5dbb33d4">loop</a> = thread-&gt;<a class="code" href="a00003.html#abd1b6bd8c48500d617d9779fcac65cdc">loop</a>;
  
  <span class="keywordflow">if</span> (fd_set_blocking( fd, 0 )) {
    free(socket);
    <span class="keywordflow">return</span>  0;
  }
  
  <a class="code" href="a00007.html#aeb35db9a7b14e4fbc3f17f4879742b5b">EVTHREAD_OBJECT_init</a>( &amp;socket-&gt;<a class="code" href="a00002.html#aa2f8699d28dc94e1acadc99a1d0aab2a">object_base</a>, <a class="code" href="a00008.html#a3cbb545676ecd40a740416851b4fff80a2411a18bbeb8291e5d6db0f70e1d4cce">EVTHREAD_OBJECT_SOCKET</a> , thread );
 
  event_set( &amp;socket-&gt;<a class="code" href="a00002.html#a424a834569ee2593b2d04b6e6ae9799b">read_event</a>, fd, EV_READ , <a class="code" href="a00007.html#a291d3071c09facfdc2359fe2ca0fa1a5">socket_cb</a>, (<span class="keywordtype">void</span> *) socket );
  event_base_set( socket-&gt;<a class="code" href="a00002.html#ab7a9905daf7aa5dc109ac87e5dbb33d4">loop</a>-&gt;<a class="code" href="a00001.html#a3ef46ca89266616a4ca06b62e60e8062">ev_base</a>, &amp;socket-&gt;<a class="code" href="a00002.html#a424a834569ee2593b2d04b6e6ae9799b">read_event</a> );

  event_set( &amp;socket-&gt;<a class="code" href="a00002.html#a25b5c3a94163a89a7bc0dff0dbdeb277">write_event</a>, fd, EV_WRITE , <a class="code" href="a00007.html#a291d3071c09facfdc2359fe2ca0fa1a5">socket_cb</a>, (<span class="keywordtype">void</span> *) socket );
  event_base_set( socket-&gt;<a class="code" href="a00002.html#ab7a9905daf7aa5dc109ac87e5dbb33d4">loop</a>-&gt;<a class="code" href="a00001.html#a3ef46ca89266616a4ca06b62e60e8062">ev_base</a>, &amp;socket-&gt;<a class="code" href="a00002.html#a25b5c3a94163a89a7bc0dff0dbdeb277">write_event</a> );

  <span class="keywordflow">return</span> socket;
}   
</pre></div>
</div>
</div>
<a class="anchor" id="ga2400bf324d24d3d0b011f32c7eceecda"></a><!-- doxytag: member="evthread.h::EVSOCKET_recv" ref="ga2400bf324d24d3d0b011f32c7eceecda" args="(EVSOCKET *socket, void *buf, size_t buf_size, int flags, struct timeval timeout)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int EVSOCKET_recv </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00002.html">EVSOCKET</a> *&#160;</td>
          <td class="paramname"><em>socket</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>buf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>buf_size</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>flags</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct timeval&#160;</td>
          <td class="paramname"><em>timeout</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="a00007_source.html#l00425">425</a> of file <a class="el" href="a00007_source.html">evthread.c</a>.</p>
<div class="fragment"><pre class="fragment">{
   <span class="keywordtype">int</span> rt;
   <span class="keywordtype">int</span> has_event = 0;

   <span class="keywordflow">if</span> ( socket-&gt;<a class="code" href="a00002.html#a8841e3dec607bf1eaeee342eda681adb">state</a> != <a class="code" href="a00012.html#gga2c41f6288c8bc944dd898419b7fbbb0caf309c7d0adb12a6b6c2db8568b2360a1">EVSOCKET_STATE_CONNECTED</a>) {
     <span class="keywordflow">return</span> -1;
   }
   
r_again:   
   <span class="keywordflow">do</span> {
     rt = recv( socket-&gt;<a class="code" href="a00002.html#ac4f60cb252957d83ab97420d9ba75a7f">fd</a>, buf, buf_size, flags);
   } <span class="keywordflow">while</span>(rt == -1 &amp;&amp; errno == EINTR);

   <span class="keywordflow">if</span> (rt == -1) {
     <span class="keywordflow">if</span> (errno == EAGAIN) {

       socket-&gt;<a class="code" href="a00002.html#a8841e3dec607bf1eaeee342eda681adb">state</a> = <a class="code" href="a00012.html#gga2c41f6288c8bc944dd898419b7fbbb0ca11d241b716a59cdbc6c07458fbefede5">EVSOCKET_STATE_READING</a>;
       socket-&gt;<a class="code" href="a00002.html#ad73f5d6d015fd3f464b9e6c1894e9836">timer_io_timeout</a> = <a class="code" href="a00011.html#gaa7702b36f1620f2526f4e57e7f4f90f4">EVTIMER_init_one_shot</a>( socket-&gt;<a class="code" href="a00002.html#ac7bd1c84d925b7c459220750b47d3d09">thread</a>, 1, timeout, <a class="code" href="a00007.html#a263766876e9dd593e9f37a825aa6bd3f">io_timeout_proc</a>, socket);

       <span class="keywordflow">if</span> (!has_event) {
         event_add( &amp;socket-&gt;<a class="code" href="a00002.html#a424a834569ee2593b2d04b6e6ae9799b">read_event</a>, 0 );
         has_event = 1;
       }

       CTHREAD_yield( 0, 0 );
       
       <span class="keywordflow">if</span> (socket-&gt;<a class="code" href="a00002.html#a8841e3dec607bf1eaeee342eda681adb">state</a> != <a class="code" href="a00012.html#gga2c41f6288c8bc944dd898419b7fbbb0ca9a409c3600e382e41ace36599966aec7">EVSOCKET_STATE_ERROR</a>) {
          <span class="keywordflow">goto</span> r_again;
       }
     }
   }

   <span class="keywordflow">if</span> (has_event) {
     event_del( &amp;socket-&gt;<a class="code" href="a00002.html#a424a834569ee2593b2d04b6e6ae9799b">read_event</a> );
   }
   
   <span class="keywordflow">if</span> (rt != -1) {
     socket-&gt;<a class="code" href="a00002.html#a8841e3dec607bf1eaeee342eda681adb">state</a> = <a class="code" href="a00012.html#gga2c41f6288c8bc944dd898419b7fbbb0caf309c7d0adb12a6b6c2db8568b2360a1">EVSOCKET_STATE_CONNECTED</a>;
   } <span class="keywordflow">else</span> {
     socket-&gt;<a class="code" href="a00002.html#a8841e3dec607bf1eaeee342eda681adb">state</a> = <a class="code" href="a00012.html#gga2c41f6288c8bc944dd898419b7fbbb0ca9a409c3600e382e41ace36599966aec7">EVSOCKET_STATE_ERROR</a>;
   }

   <span class="keywordflow">if</span> (socket-&gt;<a class="code" href="a00002.html#ad73f5d6d015fd3f464b9e6c1894e9836">timer_io_timeout</a>) {
     <a class="code" href="a00011.html#ga69cdac6c1ab58a63245fb14dfb43cc70">EVTIMER_free</a>( socket-&gt;<a class="code" href="a00002.html#ad73f5d6d015fd3f464b9e6c1894e9836">timer_io_timeout</a> ); 
     socket-&gt;<a class="code" href="a00002.html#ad73f5d6d015fd3f464b9e6c1894e9836">timer_io_timeout</a> = 0; 
   }
   <span class="keywordflow">return</span> rt;
} 
</pre></div>
</div>
</div>
<a class="anchor" id="gae70737035f6cd136a85b6b24e31fe8be"></a><!-- doxytag: member="evthread.h::EVSOCKET_recv_all" ref="gae70737035f6cd136a85b6b24e31fe8be" args="(EVSOCKET *socket, void *buf, size_t buf_size, int flags, struct timeval timeout)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int EVSOCKET_recv_all </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00002.html">EVSOCKET</a> *&#160;</td>
          <td class="paramname"><em>socket</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>buf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>buf_size</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>flags</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct timeval&#160;</td>
          <td class="paramname"><em>timeout</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="a00007_source.html#l00526">526</a> of file <a class="el" href="a00007_source.html">evthread.c</a>.</p>
<div class="fragment"><pre class="fragment">{
  uint8_t *cur = (uint8_t *) buf;
  <span class="keywordtype">int</span> pos, rt;

  <span class="keywordflow">for</span>(pos = 0 ; buf_size != 0 ; pos += rt ) {
    rt = <a class="code" href="a00012.html#ga2400bf324d24d3d0b011f32c7eceecda">EVSOCKET_recv</a>( socket, cur, buf_size, flags, timeout );
    <span class="keywordflow">if</span> (rt &lt;= 0) {
      <span class="keywordflow">return</span> rt;
    }
    cur += rt;
    buf_size -= rt;
  } 
  <span class="keywordflow">return</span> pos;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ga6c9dc88bb3fbe603473bc694664cdc7d"></a><!-- doxytag: member="evthread.h::EVSOCKET_send" ref="ga6c9dc88bb3fbe603473bc694664cdc7d" args="(EVSOCKET *socket, void *buf, size_t buf_size, int flags, struct timeval timeout)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int EVSOCKET_send </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00002.html">EVSOCKET</a> *&#160;</td>
          <td class="paramname"><em>socket</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>buf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>buf_size</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>flags</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct timeval&#160;</td>
          <td class="paramname"><em>timeout</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="a00007_source.html#l00542">542</a> of file <a class="el" href="a00007_source.html">evthread.c</a>.</p>
<div class="fragment"><pre class="fragment">{
  uint8_t *cur = (uint8_t *) buf;
  <span class="keywordtype">int</span> pos, rt;

  <span class="keywordflow">for</span>(pos = 0 ; buf_size != 0 ; pos += rt ) {

    rt = <a class="code" href="a00007.html#abcb6b7f63c1fe247e757aab22311098a">EVSOCKET_send_internal</a>( socket, cur, buf_size, flags, timeout );
    <span class="keywordflow">if</span> (rt &lt; 0) {
      <span class="keywordflow">return</span> -1;
    }
    cur += rt;
    buf_size -= rt;
  } 
  <span class="keywordflow">return</span> pos;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ga9f1eadc43b53273402e301cbecd5af2f"></a><!-- doxytag: member="evthread.h::EVSOCKET_set_idle_timeout" ref="ga9f1eadc43b53273402e301cbecd5af2f" args="(EVSOCKET *socket, struct timeval timeout)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void EVSOCKET_set_idle_timeout </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00002.html">EVSOCKET</a> *&#160;</td>
          <td class="paramname"><em>socket</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct timeval&#160;</td>
          <td class="paramname"><em>timeout</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="a00007_source.html#l00417">417</a> of file <a class="el" href="a00007_source.html">evthread.c</a>.</p>
<div class="fragment"><pre class="fragment">{ 
  <span class="keywordflow">if</span> (socket-&gt;<a class="code" href="a00002.html#ad73f5d6d015fd3f464b9e6c1894e9836">timer_io_timeout</a> != 0) {  
    <a class="code" href="a00011.html#ga69cdac6c1ab58a63245fb14dfb43cc70">EVTIMER_free</a>( socket-&gt;<a class="code" href="a00002.html#ad73f5d6d015fd3f464b9e6c1894e9836">timer_io_timeout</a> ); 
  }
  socket-&gt;<a class="code" href="a00002.html#ad73f5d6d015fd3f464b9e6c1894e9836">timer_io_timeout</a> = <a class="code" href="a00011.html#gaa7702b36f1620f2526f4e57e7f4f90f4">EVTIMER_init_one_shot</a>( socket-&gt;<a class="code" href="a00002.html#ac7bd1c84d925b7c459220750b47d3d09">thread</a>, 1, timeout, <a class="code" href="a00007.html#a263766876e9dd593e9f37a825aa6bd3f">io_timeout_proc</a>, socket);
}
</pre></div>
</div>
</div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Oct 4 2011 19:17:10 for Simple coroutine library integrated with IO event loop (libevent) / objects in plain C by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </small></address>
</body>
</html>
