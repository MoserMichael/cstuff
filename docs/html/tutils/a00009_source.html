<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Simple tools for multi threading / objects in plain C: tpool.h Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Simple tools for multi threading / objects in plain C&#160;<span id="projectnumber">Snapshot</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">tpool.h</div>  </div>
</div>
<div class="contents">
<a href="a00009.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#ifndef __TPOOL_H__</span>
<a name="l00002"></a>00002 <span class="preprocessor"></span><span class="preprocessor">#define __TPOOL_H__</span>
<a name="l00003"></a>00003 <span class="preprocessor"></span>
<a name="l00004"></a>00004 <span class="preprocessor">#include &lt;<a class="code" href="a00011.html">tutils/tqueue.h</a>&gt;</span>
<a name="l00005"></a>00005 <span class="preprocessor">#include &lt;<a class="code" href="a00007.html">tutils/cbarrier.h</a>&gt;</span>
<a name="l00006"></a>00006 
<a name="l00007"></a>00007 <span class="keyword">struct </span><a class="code" href="a00002.html">tagRUNNABLE</a>;
<a name="l00008"></a>00008 <span class="keyword">struct </span><a class="code" href="a00003.html">tagTHREADPOOL</a>;
<a name="l00009"></a>00009 
<a name="l00010"></a>00010 <span class="comment">//---</span>
<a name="l00011"></a>00011 
<a name="l00012"></a><a class="code" href="a00009.html#af16d7d96e7ed5b618a81394d68de79e4">00012</a> <span class="keyword">typedef</span> void (*<a class="code" href="a00009.html#af16d7d96e7ed5b618a81394d68de79e4">RUNNABLE_HANDLER</a>) (<span class="keyword">struct </span><a class="code" href="a00002.html">tagRUNNABLE</a> *request);
<a name="l00013"></a>00013 <span class="comment"></span>
<a name="l00014"></a>00014 <span class="comment">/**</span>
<a name="l00015"></a>00015 <span class="comment">  @defgroup RUNNABLE</span>
<a name="l00016"></a>00016 <span class="comment"></span>
<a name="l00017"></a>00017 <span class="comment">  @brief an interface to run a unit of work.</span>
<a name="l00018"></a>00018 <span class="comment"></span>
<a name="l00019"></a>00019 <span class="comment">  Acts as a work request for thread pool</span>
<a name="l00020"></a>00020 <span class="comment">  Includes a callback that is invoked in order to process the request.</span>
<a name="l00021"></a>00021 <span class="comment"></span>
<a name="l00022"></a>00022 <span class="comment">  Very similar to java concept of java.lang.Runnable.</span>
<a name="l00023"></a>00023 <span class="comment"></span>
<a name="l00024"></a>00024 <span class="comment">  @{ </span>
<a name="l00025"></a>00025 <span class="comment"> */</span>
<a name="l00026"></a><a class="code" href="a00002.html">00026</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="a00002.html">tagRUNNABLE</a> {
<a name="l00027"></a><a class="code" href="a00002.html#a127e2ce895ac78923ce28190c1c793f9">00027</a>   <a class="code" href="a00009.html#af16d7d96e7ed5b618a81394d68de79e4">RUNNABLE_HANDLER</a> <a class="code" href="a00002.html#a127e2ce895ac78923ce28190c1c793f9">handle_request</a>;
<a name="l00028"></a>00028 } <a class="code" href="a00013.html#ga3f3ff8a5ef0014f681395dda3e8e5ca6">RUNNABLE</a>;
<a name="l00029"></a>00029 <span class="comment"></span>
<a name="l00030"></a>00030 <span class="comment">/**</span>
<a name="l00031"></a>00031 <span class="comment"> @brief constructs a RUNNABLE instance</span>
<a name="l00032"></a>00032 <span class="comment"> */</span>
<a name="l00033"></a>00033 <span class="keywordtype">void</span> <a class="code" href="a00013.html#ga26254071747a14c26402a397d3766f9f" title="constructs a RUNNABLE instance">RUNNABLE_init</a>(<a class="code" href="a00002.html">RUNNABLE</a> *runnable, <a class="code" href="a00009.html#af16d7d96e7ed5b618a81394d68de79e4">RUNNABLE_HANDLER</a> handler);
<a name="l00034"></a>00034 <span class="comment"></span>
<a name="l00035"></a>00035 <span class="comment">/**</span>
<a name="l00036"></a>00036 <span class="comment"> @}</span>
<a name="l00037"></a>00037 <span class="comment"> */</span>
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 <span class="comment">// ---</span>
<a name="l00040"></a>00040 <span class="comment"></span>
<a name="l00041"></a>00041 <span class="comment">/**</span>
<a name="l00042"></a>00042 <span class="comment"></span>
<a name="l00043"></a>00043 <span class="comment"> @defgroup THREADPOOL</span>
<a name="l00044"></a>00044 <span class="comment"> </span>
<a name="l00045"></a>00045 <span class="comment"> @brief a thread pool with fixed number of worker threads.</span>
<a name="l00046"></a>00046 <span class="comment"></span>
<a name="l00047"></a>00047 <span class="comment"> The pool has a request queue: New requests are enqueued into it, the worker threads dequeue a work request and invoke the &#39;run&#39; method of work request.</span>
<a name="l00048"></a>00048 <span class="comment"></span>
<a name="l00049"></a>00049 <span class="comment"> One creation of thread pool the following parameters are specified</span>
<a name="l00050"></a>00050 <span class="comment">   - number of worker threads in thread pool.</span>
<a name="l00051"></a>00051 <span class="comment">   - maximum number of entries in request queue (or -1 if number of requests is unlimited).</span>
<a name="l00052"></a>00052 <span class="comment"></span>
<a name="l00053"></a>00053 <span class="comment"> It is very important to set a reasonable size limit on the request queue;</span>
<a name="l00054"></a>00054 <span class="comment"> An unlimited queue can often lead to out of memory conditions: If work requests</span>
<a name="l00055"></a>00055 <span class="comment"> arrive at a rate faster than what can be processed, a bounded request buffer guards against a situation where the system is run at a load rate that is higher then it&#39;s capacity.</span>
<a name="l00056"></a>00056 <span class="comment"> </span>
<a name="l00057"></a>00057 <span class="comment"> In this situation the request queue acts as a bounded buffer; it should </span>
<a name="l00058"></a>00058 <span class="comment"> be able to account for temporary fluctuations of the load; it can accomodate temporary peaks (i.e. short periods of time when the load is higher then the peak load), on condition that the request load later falls back to normal.</span>
<a name="l00059"></a>00059 <span class="comment"></span>
<a name="l00060"></a>00060 <span class="comment"> You might find this class similar to java class java.util.concurrent.ThreadPoolExicutor when used with a thread pool size.</span>
<a name="l00061"></a>00061 <span class="comment"></span>
<a name="l00062"></a>00062 <span class="comment"> @{</span>
<a name="l00063"></a>00063 <span class="comment"> */</span>
<a name="l00064"></a><a class="code" href="a00003.html">00064</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="a00003.html">tagTHREADPOOL</a> {
<a name="l00065"></a><a class="code" href="a00003.html#a0bbc9bfb92f691411651c63f2de40465">00065</a>   <span class="keywordtype">int</span> <a class="code" href="a00003.html#a0bbc9bfb92f691411651c63f2de40465">num_threads</a>;
<a name="l00066"></a><a class="code" href="a00003.html#a4b67f6780a55d06dda8ad7f893b0b95b">00066</a>   <a class="code" href="a00004.html">TQUEUE</a> <a class="code" href="a00003.html#a4b67f6780a55d06dda8ad7f893b0b95b">request_queue</a>;
<a name="l00067"></a><a class="code" href="a00003.html#a57ebff173542131630ab9542df496a2a">00067</a>   <a class="code" href="a00001.html">CYCLIC_BARRIER</a> <a class="code" href="a00003.html#a57ebff173542131630ab9542df496a2a">all_finished</a>;
<a name="l00068"></a><a class="code" href="a00003.html#a135b256b03a34d96456263b584bbddcf">00068</a>   <a class="code" href="a00009.html#af16d7d96e7ed5b618a81394d68de79e4">RUNNABLE_HANDLER</a> <a class="code" href="a00003.html#a135b256b03a34d96456263b584bbddcf">process_result</a>;
<a name="l00069"></a>00069 
<a name="l00070"></a>00070 } <a class="code" href="a00014.html#ga23469035543918e40160a7c520fa4cac">THREADPOOL</a>;
<a name="l00071"></a>00071 <span class="comment"></span>
<a name="l00072"></a>00072 <span class="comment">/**</span>
<a name="l00073"></a>00073 <span class="comment"> @brief constructs a thread pool and starts it.</span>
<a name="l00074"></a>00074 <span class="comment"></span>
<a name="l00075"></a>00075 <span class="comment"> The method </span>
<a name="l00076"></a>00076 <span class="comment">   - creates request queue </span>
<a name="l00077"></a>00077 <span class="comment">   - runs fixed number of worker threads </span>
<a name="l00078"></a>00078 <span class="comment"></span>
<a name="l00079"></a>00079 <span class="comment"> The worker thread </span>
<a name="l00080"></a>00080 <span class="comment">   - fetches a work request from the request queue</span>
<a name="l00081"></a>00081 <span class="comment">   - invokes the handle_request callback stpred in the work request </span>
<a name="l00082"></a>00082 <span class="comment">   - if process_result callback has been registered: invokes process_result</span>
<a name="l00083"></a>00083 <span class="comment">     callback (in order to have common policy of processing the results).</span>
<a name="l00084"></a>00084 <span class="comment"></span>
<a name="l00085"></a>00085 <span class="comment"> @param process_result  a callback that receives work request after invoking it&#39;s run method. Value can be 0 (in this case it is not invoked)</span>
<a name="l00086"></a>00086 <span class="comment"> @param queue_size limit on the request queue (for details see THREADPOOL )</span>
<a name="l00087"></a>00087 <span class="comment"> @param num_threads number of worker threads</span>
<a name="l00088"></a>00088 <span class="comment"> @param stack_size_kb Size of thread pool stack in kilobytes (-1 if default stack size)</span>
<a name="l00089"></a>00089 <span class="comment"></span>
<a name="l00090"></a>00090 <span class="comment"> */</span>
<a name="l00091"></a>00091 <a class="code" href="a00003.html">THREADPOOL</a> *<a class="code" href="a00014.html#ga7b909aed828b50e11051b9147aebb82f" title="constructs a thread pool and starts it.">THREADPOOL_init</a>( <a class="code" href="a00009.html#af16d7d96e7ed5b618a81394d68de79e4">RUNNABLE_HANDLER</a> process_result, <span class="keywordtype">int</span> queue_size, <span class="keywordtype">int</span> num_threads, <span class="keywordtype">int</span> stack_size_kb );
<a name="l00092"></a>00092 
<a name="l00093"></a>00093 <span class="comment">/*</span>
<a name="l00094"></a>00094 <span class="comment"> @brief shuts down the thread pool and frees it.</span>
<a name="l00095"></a>00095 <span class="comment"></span>
<a name="l00096"></a>00096 <span class="comment"> Shuts down the thread pool.</span>
<a name="l00097"></a>00097 <span class="comment"> - Requests shut down of worker threads. Please not that all requests queued at the time of this call will be discarded.</span>
<a name="l00098"></a>00098 <span class="comment"> - Blocks untill the last worker thread has finished.</span>
<a name="l00099"></a>00099 <span class="comment"></span>
<a name="l00100"></a>00100 <span class="comment"> */</span>
<a name="l00101"></a>00101 <span class="keywordtype">void</span>        <a class="code" href="a00014.html#gad367dbd16ee8e8924423fdd0a8e737f3">THREADPOOL_close</a>( <a class="code" href="a00003.html">THREADPOOL</a> *pool );
<a name="l00102"></a>00102 <span class="comment"></span>
<a name="l00103"></a>00103 <span class="comment">/**</span>
<a name="l00104"></a>00104 <span class="comment"> @brief posts a work request to the pool; blocks if request queue limit is reached</span>
<a name="l00105"></a>00105 <span class="comment"></span>
<a name="l00106"></a>00106 <span class="comment"> A request is always queued. If request queue limit is reached then this method blocks  until the size of the queue falls back, In this case the request is enqueued and this method returns.</span>
<a name="l00107"></a>00107 <span class="comment"></span>
<a name="l00108"></a>00108 <span class="comment">Returns 0 on success, -1 on failure (can&#39;t allocate memory for request)</span>
<a name="l00109"></a>00109 <span class="comment"> */</span>
<a name="l00110"></a>00110 <span class="keywordtype">int</span>         <a class="code" href="a00014.html#ga47bed275260b9a13f7ccc2b1fbe8c76a" title="posts a work request to the pool; blocks if request queue limit is reached">THREADPOOL_send_block_on_queue_full</a>( <a class="code" href="a00003.html">THREADPOOL</a> *pool, <a class="code" href="a00002.html">RUNNABLE</a> *request);
<a name="l00111"></a>00111 <span class="comment"></span>
<a name="l00112"></a>00112 <span class="comment">/**</span>
<a name="l00113"></a>00113 <span class="comment"> @brief posts a work request to the pool; blocks if request queue limit is reached</span>
<a name="l00114"></a>00114 <span class="comment"></span>
<a name="l00115"></a>00115 <span class="comment"> A request is queued if the request queue did not reach its size limit. </span>
<a name="l00116"></a>00116 <span class="comment"> If request queue limit is reached then this method returns an error.</span>
<a name="l00117"></a>00117 <span class="comment"></span>
<a name="l00118"></a>00118 <span class="comment">Returns 0 on success, -1 on failure </span>
<a name="l00119"></a>00119 <span class="comment"> */</span>
<a name="l00120"></a>00120 
<a name="l00121"></a>00121 <span class="keywordtype">int</span>         <a class="code" href="a00014.html#gac119ddd51197dc5e0d8e709f3994a5ae" title="posts a work request to the pool; blocks if request queue limit is reached">THREADPOOL_send_fail_on_queue_full</a>( <a class="code" href="a00003.html">THREADPOOL</a> *pool, <a class="code" href="a00002.html">RUNNABLE</a> *request);
<a name="l00122"></a>00122 <span class="comment"></span>
<a name="l00123"></a>00123 <span class="comment">/**</span>
<a name="l00124"></a>00124 <span class="comment">  @}</span>
<a name="l00125"></a>00125 <span class="comment"> */</span>
<a name="l00126"></a>00126  
<a name="l00127"></a>00127 
<a name="l00128"></a>00128 <span class="preprocessor">#endif</span>
<a name="l00129"></a>00129 <span class="preprocessor"></span>
<a name="l00130"></a>00130 
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Mon Sep 5 2011 13:24:23 for Simple tools for multi threading / objects in plain C by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </small></address>
</body>
</html>
