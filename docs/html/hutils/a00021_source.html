<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>HTTP Parser and message builder / objects in plain C: uri.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">HTTP Parser and message builder / objects in plain C&#160;<span id="projectnumber">Snapshot</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">uri.c</div>  </div>
</div>
<div class="contents">
<a href="a00021.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#include &quot;<a class="code" href="a00022.html">uri.h</a>&quot;</span>
<a name="l00002"></a>00002 <span class="preprocessor">#include &quot;<a class="code" href="a00014.html">charclass.h</a>&quot;</span>
<a name="l00003"></a>00003 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00004"></a>00004 <span class="preprocessor">#include &lt;arpa/inet.h&gt;</span>
<a name="l00005"></a>00005 <span class="preprocessor">#include &quot;<a class="code" href="a00020.html">sutils.h</a>&quot;</span>
<a name="l00006"></a>00006 
<a name="l00007"></a>00007 
<a name="l00008"></a>00008 
<a name="l00009"></a>00009 <span class="comment">//  mark          = &quot;-&quot; | &quot;_&quot; | &quot;.&quot; | &quot;!&quot; | &quot;~&quot; | &quot;*&quot; | &quot;&#39;&quot; | &quot;(&quot; | &quot;)&quot;</span>
<a name="l00010"></a><a class="code" href="a00021.html#a7f600c7e017e6798df185314bf06c79e">00010</a> M_INLINE <span class="keywordtype">int</span> <a class="code" href="a00021.html#a7f600c7e017e6798df185314bf06c79e">is_mark</a>(int8_t ch) {
<a name="l00011"></a>00011    <span class="keywordflow">return</span> ch == <span class="charliteral">&#39;-&#39;</span> || ch == <span class="charliteral">&#39;_&#39;</span> || ch == <span class="charliteral">&#39;.&#39;</span> || ch == <span class="charliteral">&#39;!&#39;</span> || ch == <span class="charliteral">&#39;~&#39;</span> || ch == <span class="charliteral">&#39;*&#39;</span> || ch == <span class="charliteral">&#39;\&#39;&#39;</span> || ch == <span class="charliteral">&#39;(&#39;</span> || ch == <span class="charliteral">&#39;)&#39;</span>;
<a name="l00012"></a>00012 }
<a name="l00013"></a>00013 
<a name="l00014"></a>00014 <span class="comment">//  unreserved    = alphanum | mark</span>
<a name="l00015"></a><a class="code" href="a00021.html#acce9ea7662290b5b285addb415153760">00015</a>  M_INLINE <span class="keywordtype">int</span> <a class="code" href="a00021.html#acce9ea7662290b5b285addb415153760">is_unreserved</a>(int8_t ch) {
<a name="l00016"></a>00016     <span class="keywordflow">return</span> <a class="code" href="a00014.html#a283b46097df7193a0f62701ef8b65ebb">is_alphanum</a>(ch) || <a class="code" href="a00021.html#a7f600c7e017e6798df185314bf06c79e">is_mark</a>(ch);
<a name="l00017"></a>00017 }
<a name="l00018"></a>00018 
<a name="l00019"></a>00019 <span class="comment">// reserved      = &quot;;&quot; | &quot;/&quot; | &quot;?&quot; | &quot;:&quot; | &quot;@&quot; | &quot;&amp;&quot; | &quot;=&quot; | &quot;+&quot; |  &quot;$&quot; | &quot;,&quot;</span>
<a name="l00020"></a><a class="code" href="a00021.html#a4be1d64a304771921bfb433f56da9b8e">00020</a>  M_INLINE <span class="keywordtype">int</span> <a class="code" href="a00021.html#a4be1d64a304771921bfb433f56da9b8e">is_reserved</a>(int8_t ch) {
<a name="l00021"></a>00021     <span class="keywordflow">return</span> ch == <span class="charliteral">&#39;;&#39;</span> || ch == <span class="charliteral">&#39;/&#39;</span> || ch == <span class="charliteral">&#39;?&#39;</span> || ch == <span class="charliteral">&#39;:&#39;</span> || ch == <span class="charliteral">&#39;@&#39;</span> || ch == <span class="charliteral">&#39;&amp;&#39;</span> || ch == <span class="charliteral">&#39;=&#39;</span> || ch == <span class="charliteral">&#39;+&#39;</span> || ch == <span class="charliteral">&#39;$&#39;</span> || ch == <span class="charliteral">&#39;,&#39;</span>;
<a name="l00022"></a>00022 }
<a name="l00023"></a>00023 
<a name="l00024"></a>00024 
<a name="l00025"></a><a class="code" href="a00013.html">00025</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="a00013.html">tagURIPARSECTX</a> {
<a name="l00026"></a><a class="code" href="a00013.html#a247f676f1f828f9573fab8b77d18a162">00026</a>   <a class="code" href="a00012.html">URI</a> *<a class="code" href="a00013.html#a247f676f1f828f9573fab8b77d18a162">rep</a>; 
<a name="l00027"></a><a class="code" href="a00013.html#ab0bbce6c84fdc9b47d66720287845852">00027</a>   <span class="keywordtype">char</span> *<a class="code" href="a00013.html#adb85398bbc31177e903ba48a431aabbd">cdata_pos</a>,*<a class="code" href="a00013.html#ab0bbce6c84fdc9b47d66720287845852">cdata_pos_start</a>,*<a class="code" href="a00013.html#ab5eec79fbd87a3faddbe6c6e37da4e33">cdata_pos_off</a>;
<a name="l00028"></a><a class="code" href="a00013.html#aed0cfa54ff781d5f68562a02acbf3fba">00028</a>   <span class="keywordtype">char</span> *<a class="code" href="a00013.html#aed0cfa54ff781d5f68562a02acbf3fba">cdata_raw_pos</a>; 
<a name="l00029"></a>00029 
<a name="l00030"></a><a class="code" href="a00013.html#ab6c0fad059718b37ab69741ae5761f73">00030</a>   <span class="keywordtype">char</span> *<a class="code" href="a00013.html#ab6c0fad059718b37ab69741ae5761f73">cdata_is_escaped_start</a>;
<a name="l00031"></a>00031   
<a name="l00032"></a>00032 } <a class="code" href="a00021.html#ae8eefa49928eead588c27e25064dc764">URIPARSECTX</a>;
<a name="l00033"></a>00033 
<a name="l00034"></a>00034 
<a name="l00035"></a><a class="code" href="a00021.html#abde5e24e4ee019b871ebe2a5575e270d">00035</a> <span class="keywordtype">char</span> *<a class="code" href="a00021.html#abde5e24e4ee019b871ebe2a5575e270d">ctx_copy_string_raw</a>( <a class="code" href="a00013.html">URIPARSECTX</a> *ctx, <span class="keywordtype">char</span> *start, <span class="keywordtype">char</span> *end )
<a name="l00036"></a>00036 {
<a name="l00037"></a>00037   <span class="keywordtype">char</span> *ret = ctx-&gt;<a class="code" href="a00013.html#aed0cfa54ff781d5f68562a02acbf3fba">cdata_raw_pos</a>;
<a name="l00038"></a>00038 
<a name="l00039"></a>00039   strncpy( ctx-&gt;<a class="code" href="a00013.html#aed0cfa54ff781d5f68562a02acbf3fba">cdata_raw_pos</a>, start, end - start );
<a name="l00040"></a>00040   ctx-&gt;<a class="code" href="a00013.html#aed0cfa54ff781d5f68562a02acbf3fba">cdata_raw_pos</a> += end - start;
<a name="l00041"></a>00041   * ctx-&gt;<a class="code" href="a00013.html#aed0cfa54ff781d5f68562a02acbf3fba">cdata_raw_pos</a> ++ =<span class="charliteral">&#39;\0&#39;</span>;
<a name="l00042"></a>00042 
<a name="l00043"></a>00043   <span class="keywordflow">return</span> ret;
<a name="l00044"></a>00044 }
<a name="l00045"></a>00045 
<a name="l00046"></a><a class="code" href="a00021.html#a4b4396f507fe125c822b3ca4042a41da">00046</a> <span class="keywordtype">void</span> <a class="code" href="a00021.html#a4b4396f507fe125c822b3ca4042a41da">ctx_add_escaped_char</a>( <a class="code" href="a00013.html">URIPARSECTX</a> *ctx, <span class="keywordtype">char</span> ch, <span class="keywordtype">int</span> char_encoded )
<a name="l00047"></a>00047 {
<a name="l00048"></a>00048   M_UNUSED( char_encoded );
<a name="l00049"></a>00049   * ctx-&gt;<a class="code" href="a00013.html#adb85398bbc31177e903ba48a431aabbd">cdata_pos</a> = ch;
<a name="l00050"></a>00050 
<a name="l00051"></a>00051   * ( ctx-&gt;<a class="code" href="a00013.html#ab6c0fad059718b37ab69741ae5761f73">cdata_is_escaped_start</a> + ( ctx-&gt;<a class="code" href="a00013.html#adb85398bbc31177e903ba48a431aabbd">cdata_pos</a> - ctx-&gt;<a class="code" href="a00013.html#ab5eec79fbd87a3faddbe6c6e37da4e33">cdata_pos_off</a> ) ) =  (char) char_encoded;
<a name="l00052"></a>00052 
<a name="l00053"></a>00053   ++ ctx-&gt;<a class="code" href="a00013.html#adb85398bbc31177e903ba48a431aabbd">cdata_pos</a>;
<a name="l00054"></a>00054  
<a name="l00055"></a>00055 <span class="comment">//ctx-&gt;cdata_pos - ctx-&gt;cdata_pos_start</span>
<a name="l00056"></a>00056 }
<a name="l00057"></a>00057 
<a name="l00058"></a><a class="code" href="a00021.html#a0ad56df073d2ba27ea027e41469b3f9c">00058</a> <span class="keywordtype">char</span> *<a class="code" href="a00021.html#a0ad56df073d2ba27ea027e41469b3f9c">ctx_finish_escaped_string</a>( <a class="code" href="a00013.html">URIPARSECTX</a> *ctx ) 
<a name="l00059"></a>00059 {
<a name="l00060"></a>00060   <span class="keywordtype">char</span> *ret = ctx-&gt;<a class="code" href="a00013.html#ab0bbce6c84fdc9b47d66720287845852">cdata_pos_start</a>;
<a name="l00061"></a>00061  
<a name="l00062"></a>00062   * ctx-&gt;<a class="code" href="a00013.html#adb85398bbc31177e903ba48a431aabbd">cdata_pos</a> ++ = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00063"></a>00063   ctx-&gt;<a class="code" href="a00013.html#ab0bbce6c84fdc9b47d66720287845852">cdata_pos_start</a> = ctx-&gt;<a class="code" href="a00013.html#adb85398bbc31177e903ba48a431aabbd">cdata_pos</a>;
<a name="l00064"></a>00064  
<a name="l00065"></a>00065  <span class="keywordflow">return</span> ret;
<a name="l00066"></a>00066 }
<a name="l00067"></a>00067 
<a name="l00068"></a><a class="code" href="a00021.html#a80e6ead0b8e5e18540ac5e23d60575b4">00068</a> <span class="keywordtype">void</span> <a class="code" href="a00021.html#a80e6ead0b8e5e18540ac5e23d60575b4">ctx_undo_escaped_string</a>( <a class="code" href="a00013.html">URIPARSECTX</a> *ctx )
<a name="l00069"></a>00069 {
<a name="l00070"></a>00070   ctx-&gt;<a class="code" href="a00013.html#adb85398bbc31177e903ba48a431aabbd">cdata_pos</a> = ctx-&gt;<a class="code" href="a00013.html#ab0bbce6c84fdc9b47d66720287845852">cdata_pos_start</a>;
<a name="l00071"></a>00071 }
<a name="l00072"></a>00072  
<a name="l00073"></a>00073 <span class="comment">// escaped       = &quot;%&quot; hex hex</span>
<a name="l00074"></a>00074 
<a name="l00075"></a><a class="code" href="a00021.html#a0b56a1f8c34732e7d34f6a26071196ff">00075</a> M_INLINE <span class="keywordtype">int</span> <a class="code" href="a00021.html#a0b56a1f8c34732e7d34f6a26071196ff">parse_escaped</a>( <a class="code" href="a00013.html">URIPARSECTX</a> *ctx,  <span class="keywordtype">char</span> *ptr, <span class="keywordtype">char</span> ** next )
<a name="l00076"></a>00076 {  
<a name="l00077"></a>00077   <span class="keywordtype">int</span> high,low;
<a name="l00078"></a>00078   <span class="keywordtype">int</span> unescaped_char;
<a name="l00079"></a>00079 
<a name="l00080"></a>00080   <span class="keywordflow">if</span> (*ptr != <span class="charliteral">&#39;%&#39;</span>) {
<a name="l00081"></a>00081     <span class="keywordflow">return</span> 1;
<a name="l00082"></a>00082   }
<a name="l00083"></a>00083 
<a name="l00084"></a>00084   high = <a class="code" href="a00014.html#ae41c2dfdb3827d25ed2cd83a85c90343">is_hex_ext</a>( *(ptr + 1) );
<a name="l00085"></a>00085   <span class="keywordflow">if</span> (! high ) {
<a name="l00086"></a>00086     <span class="keywordflow">return</span> -1;
<a name="l00087"></a>00087   }
<a name="l00088"></a>00088 
<a name="l00089"></a>00089   low = <a class="code" href="a00014.html#ae41c2dfdb3827d25ed2cd83a85c90343">is_hex_ext</a>( *(ptr + 2) );  
<a name="l00090"></a>00090   <span class="keywordflow">if</span> (! low ) {
<a name="l00091"></a>00091     <span class="keywordflow">return</span> -1;
<a name="l00092"></a>00092   }
<a name="l00093"></a>00093   
<a name="l00094"></a>00094   unescaped_char = (high &lt;&lt; 4) | low;
<a name="l00095"></a>00095   <span class="keywordflow">if</span> (! (unescaped_char &gt;=0 &amp;&amp; unescaped_char &lt;= 0x1F) ) {
<a name="l00096"></a>00096     <a class="code" href="a00021.html#a4b4396f507fe125c822b3ca4042a41da">ctx_add_escaped_char</a>( ctx, unescaped_char, 1 );
<a name="l00097"></a>00097   }
<a name="l00098"></a>00098 
<a name="l00099"></a>00099   *next = ptr + 3;
<a name="l00100"></a>00100   <span class="keywordflow">return</span> 0;
<a name="l00101"></a>00101 } 
<a name="l00102"></a>00102 
<a name="l00103"></a>00103 <span class="comment">//      uric          = reserved | unreserved | escaped</span>
<a name="l00104"></a><a class="code" href="a00021.html#aa28908824686b0d40be21534a60ed2b9">00104</a> M_INLINE <span class="keywordtype">int</span> <a class="code" href="a00021.html#aa28908824686b0d40be21534a60ed2b9">parse_uric</a>( <a class="code" href="a00013.html">URIPARSECTX</a> *ctx, <span class="keywordtype">char</span> *ptr, <span class="keywordtype">char</span> **next )
<a name="l00105"></a>00105 {
<a name="l00106"></a>00106    <span class="keywordflow">if</span> (<a class="code" href="a00021.html#a4be1d64a304771921bfb433f56da9b8e">is_reserved</a>( *ptr ) || <a class="code" href="a00021.html#acce9ea7662290b5b285addb415153760">is_unreserved</a>( *ptr ) ) {
<a name="l00107"></a>00107      <a class="code" href="a00021.html#a4b4396f507fe125c822b3ca4042a41da">ctx_add_escaped_char</a>( ctx, *ptr, 0 );
<a name="l00108"></a>00108      *next = ptr +1;
<a name="l00109"></a>00109      <span class="keywordflow">return</span> 0;
<a name="l00110"></a>00110    }    
<a name="l00111"></a>00111    <span class="keywordflow">return</span> <a class="code" href="a00021.html#a0b56a1f8c34732e7d34f6a26071196ff">parse_escaped</a>( ctx, ptr, next );
<a name="l00112"></a>00112 }
<a name="l00113"></a>00113 
<a name="l00114"></a>00114 
<a name="l00115"></a><a class="code" href="a00021.html#adfb50d1059700bd12272e3a5fba61461">00115</a> M_INLINE <span class="keywordtype">int</span> <a class="code" href="a00021.html#adfb50d1059700bd12272e3a5fba61461">parse_uric_sequence</a>( <a class="code" href="a00013.html">URIPARSECTX</a> *ctx, <span class="keywordtype">char</span> *ptr, <span class="keywordtype">char</span> **next ) 
<a name="l00116"></a>00116 {
<a name="l00117"></a>00117   <span class="keywordtype">int</span> rt;
<a name="l00118"></a>00118 
<a name="l00119"></a>00119   <span class="keywordflow">while</span>( (rt = <a class="code" href="a00021.html#aa28908824686b0d40be21534a60ed2b9">parse_uric</a>(  ctx, ptr, next )) == 0 ) {
<a name="l00120"></a>00120     ptr = *next;
<a name="l00121"></a>00121   }
<a name="l00122"></a>00122   <span class="keywordflow">return</span> rt;
<a name="l00123"></a>00123 }
<a name="l00124"></a>00124 
<a name="l00125"></a>00125 <span class="comment">//    pchar         = unreserved | escaped |</span>
<a name="l00126"></a>00126 <span class="comment">//                      &quot;:&quot; | &quot;@&quot; | &quot;&amp;&quot; | &quot;=&quot; | &quot;+&quot; | &quot;$&quot; | &quot;,&quot;</span>
<a name="l00127"></a><a class="code" href="a00021.html#a98de74d7af924a1394abb989b52dfe6f">00127</a> M_INLINE <span class="keywordtype">int</span> <a class="code" href="a00021.html#a98de74d7af924a1394abb989b52dfe6f">parse_pchar</a>( <a class="code" href="a00013.html">URIPARSECTX</a> *ctx, <span class="keywordtype">char</span> *ptr, <span class="keywordtype">char</span> **next)
<a name="l00128"></a>00128 {
<a name="l00129"></a>00129   <span class="keywordtype">char</span> ch = *ptr;
<a name="l00130"></a>00130 
<a name="l00131"></a>00131   <span class="keywordflow">if</span> (<a class="code" href="a00021.html#acce9ea7662290b5b285addb415153760">is_unreserved</a>( ch ) || ch == <span class="charliteral">&#39;:&#39;</span> || ch == <span class="charliteral">&#39;@&#39;</span> || ch == <span class="charliteral">&#39;&amp;&#39;</span> || ch == <span class="charliteral">&#39;=&#39;</span> || ch == <span class="charliteral">&#39;+&#39;</span> || ch == <span class="charliteral">&#39;$&#39;</span> || ch == <span class="charliteral">&#39;,&#39;</span>) {
<a name="l00132"></a>00132     <a class="code" href="a00021.html#a4b4396f507fe125c822b3ca4042a41da">ctx_add_escaped_char</a>( ctx, ch, 0 );
<a name="l00133"></a>00133     *next = ptr + 1;
<a name="l00134"></a>00134     <span class="keywordflow">return</span> 0;
<a name="l00135"></a>00135   }
<a name="l00136"></a>00136   <span class="keywordflow">return</span> <a class="code" href="a00021.html#a0b56a1f8c34732e7d34f6a26071196ff">parse_escaped</a>(  ctx, ptr, next );
<a name="l00137"></a>00137 }
<a name="l00138"></a>00138 
<a name="l00139"></a><a class="code" href="a00021.html#aa42297e323b57f1d41ecc6ab66d15228">00139</a> M_INLINE <span class="keywordtype">int</span> <a class="code" href="a00021.html#aa42297e323b57f1d41ecc6ab66d15228">parse_pchar_sequence</a>( <a class="code" href="a00013.html">URIPARSECTX</a> *ctx, <span class="keywordtype">char</span> *ptr, <span class="keywordtype">char</span> **next ) 
<a name="l00140"></a>00140 {
<a name="l00141"></a>00141   <span class="keywordtype">int</span> rt;
<a name="l00142"></a>00142 
<a name="l00143"></a>00143   <span class="keywordflow">while</span>( (rt = <a class="code" href="a00021.html#a98de74d7af924a1394abb989b52dfe6f">parse_pchar</a>( ctx, ptr, next )) == 0 ) {
<a name="l00144"></a>00144     ptr = *next;
<a name="l00145"></a>00145   }
<a name="l00146"></a>00146   <span class="keywordflow">return</span> 0;
<a name="l00147"></a>00147 }
<a name="l00148"></a>00148 
<a name="l00149"></a>00149 <span class="comment">//      segment       = *pchar *( &quot;;&quot; param )</span>
<a name="l00150"></a><a class="code" href="a00021.html#a09d4853f4d37fd26d138645da055bafc">00150</a> M_INLINE <span class="keywordtype">int</span> <a class="code" href="a00021.html#a09d4853f4d37fd26d138645da055bafc">parse_segment</a>( <a class="code" href="a00013.html">URIPARSECTX</a> *ctx, <span class="keywordtype">char</span> *ptr, <span class="keywordtype">char</span> **next ) 
<a name="l00151"></a>00151 {
<a name="l00152"></a>00152   <span class="keywordflow">if</span> (<a class="code" href="a00021.html#aa42297e323b57f1d41ecc6ab66d15228">parse_pchar_sequence</a>( ctx, ptr, next ) &lt; 0) {
<a name="l00153"></a>00153     <span class="keywordflow">return</span> -1;
<a name="l00154"></a>00154   }
<a name="l00155"></a>00155   
<a name="l00156"></a>00156   ptr = *next;
<a name="l00157"></a>00157   <span class="keywordflow">if</span> (*ptr == <span class="charliteral">&#39;;&#39;</span>) {
<a name="l00158"></a>00158     <a class="code" href="a00021.html#a4b4396f507fe125c822b3ca4042a41da">ctx_add_escaped_char</a>( ctx, <span class="charliteral">&#39;;&#39;</span>, 0 );
<a name="l00159"></a>00159     ptr = *next = ptr + 1;
<a name="l00160"></a>00160     <span class="keywordflow">if</span> (<a class="code" href="a00021.html#aa42297e323b57f1d41ecc6ab66d15228">parse_pchar_sequence</a>( ctx, ptr, next ) &lt; 0) {
<a name="l00161"></a>00161       <span class="keywordflow">return</span> -1;
<a name="l00162"></a>00162     }
<a name="l00163"></a>00163   }
<a name="l00164"></a>00164   <span class="keywordflow">return</span> 0;
<a name="l00165"></a>00165 }
<a name="l00166"></a>00166 
<a name="l00167"></a>00167 <span class="comment">//path_segments = segment *( &quot;/&quot; segment )</span>
<a name="l00168"></a><a class="code" href="a00021.html#a55e2a69ac69cfed87ca6c2dc94b41e07">00168</a> M_INLINE <span class="keywordtype">int</span> <a class="code" href="a00021.html#a55e2a69ac69cfed87ca6c2dc94b41e07">parse_path_segments</a>( <a class="code" href="a00013.html">URIPARSECTX</a> *ctx, <span class="keywordtype">char</span> *ptr, <span class="keywordtype">char</span> **next ) {
<a name="l00169"></a>00169   <span class="keywordflow">if</span> (<a class="code" href="a00021.html#a09d4853f4d37fd26d138645da055bafc">parse_segment</a>( ctx, ptr, next ) &lt; 0) {
<a name="l00170"></a>00170     <span class="keywordflow">return</span> -1;
<a name="l00171"></a>00171   }
<a name="l00172"></a>00172   ptr = *next;
<a name="l00173"></a>00173   <span class="keywordflow">while</span> (*ptr == <span class="charliteral">&#39;/&#39;</span>) {
<a name="l00174"></a>00174     <a class="code" href="a00021.html#a4b4396f507fe125c822b3ca4042a41da">ctx_add_escaped_char</a>( ctx, <span class="charliteral">&#39;/&#39;</span>, 0 );
<a name="l00175"></a>00175     ptr = *next = ptr + 1;
<a name="l00176"></a>00176     <span class="keywordflow">if</span> (<a class="code" href="a00021.html#a09d4853f4d37fd26d138645da055bafc">parse_segment</a>( ctx, ptr, next ) &lt; 0) {
<a name="l00177"></a>00177       <span class="keywordflow">return</span> -1;
<a name="l00178"></a>00178     }
<a name="l00179"></a>00179     ptr = *next;
<a name="l00180"></a>00180   }
<a name="l00181"></a>00181   <span class="keywordflow">return</span> 0;
<a name="l00182"></a>00182 }
<a name="l00183"></a>00183 
<a name="l00184"></a><a class="code" href="a00021.html#a631c7bb7fc4481fd87c0ba388854ca04">00184</a> M_INLINE <span class="keywordtype">int</span> <a class="code" href="a00021.html#a631c7bb7fc4481fd87c0ba388854ca04">parse_ipv4_address</a>( <a class="code" href="a00013.html">URIPARSECTX</a> *ctx,  <span class="keywordtype">char</span> *ptr, <span class="keywordtype">char</span> **next ) {
<a name="l00185"></a>00185   <span class="keywordtype">int</span> i;
<a name="l00186"></a>00186 
<a name="l00187"></a>00187   <span class="keywordtype">char</span> *start = ptr;
<a name="l00188"></a>00188 
<a name="l00189"></a>00189   <span class="keywordflow">for</span> (i=0; i &lt; 4; i++) {
<a name="l00190"></a>00190     <span class="keywordflow">if</span> (! <a class="code" href="a00014.html#a0e785ba5f60fda38d1abd5af67581f04">is_digit</a>(*ptr)) {
<a name="l00191"></a>00191       <span class="keywordflow">return</span> -1;
<a name="l00192"></a>00192     }
<a name="l00193"></a>00193     <span class="keywordflow">for</span>( ++ ptr; <a class="code" href="a00014.html#a0e785ba5f60fda38d1abd5af67581f04">is_digit</a>( *ptr ); ++ptr );
<a name="l00194"></a>00194     <span class="keywordflow">if</span> ( i == 3) {
<a name="l00195"></a>00195       <span class="keywordflow">break</span>;
<a name="l00196"></a>00196     }
<a name="l00197"></a>00197     <span class="keywordflow">if</span> (*ptr != <span class="charliteral">&#39;.&#39;</span>) {
<a name="l00198"></a>00198       <span class="keywordflow">return</span> -1;
<a name="l00199"></a>00199     } 
<a name="l00200"></a>00200     ++ ptr;
<a name="l00201"></a>00201   }
<a name="l00202"></a>00202 
<a name="l00203"></a>00203   *next = ptr;
<a name="l00204"></a>00204   ctx-&gt;<a class="code" href="a00013.html#a247f676f1f828f9573fab8b77d18a162">rep</a>-&gt;<a class="code" href="a00012.html#a51cab48f1903d47847abd4fd2faa16dd">flags</a> |= <a class="code" href="a00030.html#ga88117f2de53ca60461fdbfc19195c5e6">URI_FLAGS_HOST_IPv4</a>;  
<a name="l00205"></a>00205   ctx-&gt;<a class="code" href="a00013.html#a247f676f1f828f9573fab8b77d18a162">rep</a>-&gt;<a class="code" href="a00012.html#a7ec586c2aee51d79c245ffce344a6c18">host</a> = <a class="code" href="a00021.html#abde5e24e4ee019b871ebe2a5575e270d">ctx_copy_string_raw</a>(ctx, start, ptr );
<a name="l00206"></a>00206 
<a name="l00207"></a>00207   <span class="keywordflow">return</span> 0;
<a name="l00208"></a>00208 }
<a name="l00209"></a>00209 
<a name="l00210"></a>00210 <span class="comment">//[ userinfo &quot;@&quot; ] </span>
<a name="l00211"></a>00211 <span class="comment">//userinfo      = *( unreserved | escaped |</span>
<a name="l00212"></a>00212 <span class="comment">//                   &quot;;&quot; | &quot;:&quot; | &quot;&amp;&quot; | &quot;=&quot; | &quot;+&quot; | &quot;$&quot; | &quot;,&quot; )</span>
<a name="l00213"></a><a class="code" href="a00021.html#aab2f681a85eb14cf468100ce68ed20ab">00213</a> M_INLINE <span class="keywordtype">int</span> <a class="code" href="a00021.html#aab2f681a85eb14cf468100ce68ed20ab">parse_userinfo</a>( <a class="code" href="a00013.html">URIPARSECTX</a> *ctx, <span class="keywordtype">char</span> *ptr, <span class="keywordtype">char</span> **next)
<a name="l00214"></a>00214 {
<a name="l00215"></a>00215     <span class="keywordtype">char</span> *start = ptr;
<a name="l00216"></a>00216     <span class="keywordtype">int</span> rt;
<a name="l00217"></a>00217 
<a name="l00218"></a>00218     <span class="keywordflow">while</span> ( *ptr  != <span class="charliteral">&#39;@&#39;</span> ) {
<a name="l00219"></a>00219        <span class="keywordflow">if</span> ( <a class="code" href="a00021.html#acce9ea7662290b5b285addb415153760">is_unreserved</a>( *ptr ) || *ptr == <span class="charliteral">&#39;;&#39;</span> || *ptr ==  <span class="charliteral">&#39;:&#39;</span> || *ptr ==  <span class="charliteral">&#39;&amp;&#39;</span> 
<a name="l00220"></a>00220                 || *ptr ==  <span class="charliteral">&#39;=&#39;</span> || *ptr ==  <span class="charliteral">&#39;+&#39;</span> || *ptr ==  <span class="charliteral">&#39;$&#39;</span> || *ptr ==  <span class="charliteral">&#39;,&#39;</span>) {
<a name="l00221"></a>00221          <a class="code" href="a00021.html#a4b4396f507fe125c822b3ca4042a41da">ctx_add_escaped_char</a>( ctx, *ptr, 0 );
<a name="l00222"></a>00222          ++ ptr;
<a name="l00223"></a>00223          <span class="keywordflow">continue</span>;
<a name="l00224"></a>00224        } 
<a name="l00225"></a>00225        <span class="keywordflow">if</span> ((rt = <a class="code" href="a00021.html#a0b56a1f8c34732e7d34f6a26071196ff">parse_escaped</a>( ctx, ptr, next )) != 0) {
<a name="l00226"></a>00226          <a class="code" href="a00021.html#a80e6ead0b8e5e18540ac5e23d60575b4">ctx_undo_escaped_string</a>( ctx );  
<a name="l00227"></a>00227          *next = start;
<a name="l00228"></a>00228          <span class="keywordflow">return</span> rt;
<a name="l00229"></a>00229        }  
<a name="l00230"></a>00230        ptr = *next;
<a name="l00231"></a>00231     }
<a name="l00232"></a>00232 
<a name="l00233"></a>00233     ctx-&gt;<a class="code" href="a00013.html#a247f676f1f828f9573fab8b77d18a162">rep</a>-&gt;<a class="code" href="a00012.html#ada1006ea50c7792e3645fc5be0dc3a2d">userinfo_raw</a> = <a class="code" href="a00021.html#abde5e24e4ee019b871ebe2a5575e270d">ctx_copy_string_raw</a>(ctx, start, ptr );
<a name="l00234"></a>00234     ctx-&gt;<a class="code" href="a00013.html#a247f676f1f828f9573fab8b77d18a162">rep</a>-&gt;<a class="code" href="a00012.html#afff11e0c3c453382ec37ea31aee23753">userinfo</a> =  <a class="code" href="a00021.html#a0ad56df073d2ba27ea027e41469b3f9c">ctx_finish_escaped_string</a>(ctx); 
<a name="l00235"></a>00235     *next = ptr + 1;
<a name="l00236"></a>00236 
<a name="l00237"></a>00237     <span class="keywordflow">return</span> 0;
<a name="l00238"></a>00238 }
<a name="l00239"></a>00239 
<a name="l00240"></a>00240 
<a name="l00241"></a><a class="code" href="a00021.html#ae0824c26d405c6e026b81e5863a7ee3e">00241</a> M_INLINE <span class="keywordtype">int</span> <a class="code" href="a00021.html#ae0824c26d405c6e026b81e5863a7ee3e">parse_domainlabel</a>(  <span class="keywordtype">char</span> *ptr, <span class="keywordtype">char</span> **next )
<a name="l00242"></a>00242 {
<a name="l00243"></a>00243    <span class="keywordflow">if</span> (!<a class="code" href="a00014.html#a283b46097df7193a0f62701ef8b65ebb">is_alphanum</a>( *ptr) ) {
<a name="l00244"></a>00244      <span class="keywordflow">return</span> -1;
<a name="l00245"></a>00245    }
<a name="l00246"></a>00246    <span class="keywordflow">for</span>(ptr += 1; <a class="code" href="a00014.html#a283b46097df7193a0f62701ef8b65ebb">is_alphanum</a>( *ptr ) || *ptr == <span class="charliteral">&#39;-&#39;</span>; ++ptr);
<a name="l00247"></a>00247    
<a name="l00248"></a>00248    <span class="keywordflow">if</span> (!<a class="code" href="a00014.html#a283b46097df7193a0f62701ef8b65ebb">is_alphanum</a>( *(ptr-1) ) ) {
<a name="l00249"></a>00249      <span class="keywordflow">return</span> -1;
<a name="l00250"></a>00250    }
<a name="l00251"></a>00251    *next = ptr;
<a name="l00252"></a>00252 
<a name="l00253"></a>00253    <span class="keywordflow">return</span> 0;
<a name="l00254"></a>00254 }
<a name="l00255"></a>00255 
<a name="l00256"></a>00256 <span class="comment">//hostname      = *( domainlabel &quot;.&quot; ) toplabel [ &quot;.&quot; ]</span>
<a name="l00257"></a>00257 <span class="comment">//domainlabel   = alphanum | alphanum *( alphanum | &quot;-&quot; ) alphanum</span>
<a name="l00258"></a>00258 <span class="comment">//toplabel      = alpha | alpha *( alphanum | &quot;-&quot; ) alphanum</span>
<a name="l00259"></a><a class="code" href="a00021.html#af8279a3b2cdc184e6a3e320792259b19">00259</a> M_INLINE <span class="keywordtype">int</span> <a class="code" href="a00021.html#af8279a3b2cdc184e6a3e320792259b19">parse_hostname</a>(  <a class="code" href="a00013.html">URIPARSECTX</a> *ctx, <span class="keywordtype">char</span> *ptr, <span class="keywordtype">char</span> **next )
<a name="l00260"></a>00260 {
<a name="l00261"></a>00261    <span class="keywordtype">char</span> *last_component;
<a name="l00262"></a>00262    <span class="keywordtype">char</span> *start = ptr;
<a name="l00263"></a>00263 
<a name="l00264"></a>00264    <span class="keywordflow">for</span> ( ; ; ) {
<a name="l00265"></a>00265        last_component = ptr;
<a name="l00266"></a>00266        <span class="keywordflow">if</span> (*ptr == <span class="charliteral">&#39;/&#39;</span>) {
<a name="l00267"></a>00267          <span class="keywordflow">goto</span> ok;
<a name="l00268"></a>00268        }
<a name="l00269"></a>00269        <span class="keywordflow">if</span> (<a class="code" href="a00021.html#ae0824c26d405c6e026b81e5863a7ee3e">parse_domainlabel</a>( ptr, next) &lt; 0) {
<a name="l00270"></a>00270          <span class="keywordflow">return</span> -1;
<a name="l00271"></a>00271        }
<a name="l00272"></a>00272        ptr = *next;
<a name="l00273"></a>00273  
<a name="l00274"></a>00274        <span class="keywordflow">if</span> (*ptr != <span class="charliteral">&#39;.&#39;</span>) { 
<a name="l00275"></a>00275          <span class="keywordflow">break</span>;
<a name="l00276"></a>00276        }
<a name="l00277"></a>00277        ++ptr;
<a name="l00278"></a>00278     }
<a name="l00279"></a>00279     <span class="comment">// check that last component is top label</span>
<a name="l00280"></a>00280     <span class="keywordflow">if</span> (<a class="code" href="a00014.html#a0e785ba5f60fda38d1abd5af67581f04">is_digit</a>( * last_component ) ) {
<a name="l00281"></a>00281        <span class="keywordflow">return</span> -1;
<a name="l00282"></a>00282     }
<a name="l00283"></a>00283 
<a name="l00284"></a>00284 ok:
<a name="l00285"></a>00285     *next = ptr;
<a name="l00286"></a>00286  
<a name="l00287"></a>00287     ctx-&gt;<a class="code" href="a00013.html#a247f676f1f828f9573fab8b77d18a162">rep</a>-&gt;<a class="code" href="a00012.html#a51cab48f1903d47847abd4fd2faa16dd">flags</a> |= <a class="code" href="a00030.html#gaa8b74e1e32f1bfcbdc1c35bc351d0c37">URI_FLAGS_HOST_HOSTNAME</a>;   
<a name="l00288"></a>00288     ctx-&gt;<a class="code" href="a00013.html#a247f676f1f828f9573fab8b77d18a162">rep</a>-&gt;<a class="code" href="a00012.html#a7ec586c2aee51d79c245ffce344a6c18">host</a> = <a class="code" href="a00021.html#abde5e24e4ee019b871ebe2a5575e270d">ctx_copy_string_raw</a>(ctx, start, ptr );
<a name="l00289"></a>00289     
<a name="l00290"></a>00290     <span class="keywordflow">return</span> 0;
<a name="l00291"></a>00291 }
<a name="l00292"></a>00292 
<a name="l00293"></a>00293 
<a name="l00294"></a><a class="code" href="a00021.html#a3454d9f952367c406bc9232cd3dd45a2">00294</a> M_INLINE <span class="keywordtype">int</span> <a class="code" href="a00021.html#a3454d9f952367c406bc9232cd3dd45a2">parse_ipv6_address</a>(  <a class="code" href="a00013.html">URIPARSECTX</a> *ctx, <span class="keywordtype">char</span> *ptr, <span class="keywordtype">char</span> **next )
<a name="l00295"></a>00295 { 
<a name="l00296"></a>00296    <span class="keyword">struct </span>in6_addr addr;
<a name="l00297"></a>00297    <span class="keywordtype">char</span> *dup, *start;
<a name="l00298"></a>00298    <span class="keywordtype">int</span> rt;
<a name="l00299"></a>00299 
<a name="l00300"></a>00300 
<a name="l00301"></a>00301    <span class="keywordflow">if</span> (*ptr != <span class="charliteral">&#39;[&#39;</span>) {
<a name="l00302"></a>00302      <span class="keywordflow">return</span> 1;
<a name="l00303"></a>00303    }
<a name="l00304"></a>00304 
<a name="l00305"></a>00305    start = ptr;
<a name="l00306"></a>00306    <span class="keywordflow">for</span>(;*ptr != <span class="charliteral">&#39;]&#39;</span> &amp;&amp; *ptr != <span class="charliteral">&#39;\0&#39;</span>; ++ ptr);
<a name="l00307"></a>00307    <span class="keywordflow">if</span> (*ptr != <span class="charliteral">&#39;]&#39;</span>) {
<a name="l00308"></a>00308      <span class="keywordflow">return</span> -1;
<a name="l00309"></a>00309    }
<a name="l00310"></a>00310 
<a name="l00311"></a>00311    dup = <a class="code" href="a00020.html#ac3b6bc5a3df3720ec7dd261c75ce20ac">strdup_range</a>( start+1, ptr );
<a name="l00312"></a>00312    <span class="keywordflow">if</span> (!dup) {
<a name="l00313"></a>00313      <span class="keywordflow">return</span> -1;
<a name="l00314"></a>00314    }
<a name="l00315"></a>00315    rt = inet_pton( AF_INET6, dup, &amp;addr); 
<a name="l00316"></a>00316    free(dup);
<a name="l00317"></a>00317    <span class="keywordflow">if</span> (rt == 1) {
<a name="l00318"></a>00318      ctx-&gt;<a class="code" href="a00013.html#a247f676f1f828f9573fab8b77d18a162">rep</a>-&gt;<a class="code" href="a00012.html#a51cab48f1903d47847abd4fd2faa16dd">flags</a> |= <a class="code" href="a00030.html#gabdb6298e0841c217c1799c247fd27e60">URI_FLAGS_HOST_IPv6</a>;   
<a name="l00319"></a>00319      ctx-&gt;<a class="code" href="a00013.html#a247f676f1f828f9573fab8b77d18a162">rep</a>-&gt;<a class="code" href="a00012.html#a7ec586c2aee51d79c245ffce344a6c18">host</a> = <a class="code" href="a00021.html#abde5e24e4ee019b871ebe2a5575e270d">ctx_copy_string_raw</a>(ctx, start, ptr );
<a name="l00320"></a>00320      
<a name="l00321"></a>00321      *next = ptr + 1;
<a name="l00322"></a>00322      <span class="keywordflow">return</span> 0;
<a name="l00323"></a>00323    }
<a name="l00324"></a>00324    <span class="keywordflow">return</span> -1;
<a name="l00325"></a>00325 }
<a name="l00326"></a>00326 
<a name="l00327"></a>00327 
<a name="l00328"></a>00328 
<a name="l00329"></a>00329 <span class="comment">//hostport      = host [ &quot;:&quot; port ]</span>
<a name="l00330"></a>00330 <span class="comment">//host          = hostname | IPv4address | Ipv6address</span>
<a name="l00331"></a><a class="code" href="a00021.html#a66ff71abf545fe5b8177bd642e16653c">00331</a> M_INLINE <span class="keywordtype">int</span> <a class="code" href="a00021.html#a66ff71abf545fe5b8177bd642e16653c">parse_hostport</a>(  <a class="code" href="a00013.html">URIPARSECTX</a> *ctx, <span class="keywordtype">char</span> *ptr, <span class="keywordtype">char</span> **next )
<a name="l00332"></a>00332 {
<a name="l00333"></a>00333    <span class="keywordtype">char</span> *start;
<a name="l00334"></a>00334 
<a name="l00335"></a>00335    <span class="keywordflow">if</span> ( ! <a class="code" href="a00021.html#a631c7bb7fc4481fd87c0ba388854ca04">parse_ipv4_address</a>( ctx, ptr, next ) ) {
<a name="l00336"></a>00336      <span class="keywordflow">goto</span> pport;
<a name="l00337"></a>00337    }
<a name="l00338"></a>00338 
<a name="l00339"></a>00339    <span class="keywordflow">if</span> ( ! <a class="code" href="a00021.html#af8279a3b2cdc184e6a3e320792259b19">parse_hostname</a>( ctx, ptr, next) ) {
<a name="l00340"></a>00340      <span class="keywordflow">goto</span> pport;
<a name="l00341"></a>00341    }
<a name="l00342"></a>00342 
<a name="l00343"></a>00343    <span class="keywordflow">if</span> ( ! <a class="code" href="a00021.html#a3454d9f952367c406bc9232cd3dd45a2">parse_ipv6_address</a>( ctx, ptr, next ) ) {
<a name="l00344"></a>00344      <span class="keywordflow">goto</span> pport;
<a name="l00345"></a>00345    }
<a name="l00346"></a>00346 
<a name="l00347"></a>00347    <span class="keywordflow">return</span> -1;
<a name="l00348"></a>00348 
<a name="l00349"></a>00349 pport:
<a name="l00350"></a>00350 
<a name="l00351"></a>00351    ptr = *next;
<a name="l00352"></a>00352 
<a name="l00353"></a>00353    <span class="keywordflow">if</span> (*ptr != <span class="charliteral">&#39;:&#39;</span> ) {
<a name="l00354"></a>00354       <span class="keywordflow">return</span> 0;
<a name="l00355"></a>00355    }
<a name="l00356"></a>00356    
<a name="l00357"></a>00357    <span class="keywordflow">for</span>( start = ptr = ptr + 1; <a class="code" href="a00014.html#a0e785ba5f60fda38d1abd5af67581f04">is_digit</a>( *ptr ); ++ ptr );
<a name="l00358"></a>00358    *next = ptr;
<a name="l00359"></a>00359 
<a name="l00360"></a>00360    ctx-&gt;<a class="code" href="a00013.html#a247f676f1f828f9573fab8b77d18a162">rep</a>-&gt;<a class="code" href="a00012.html#a90106354cb3a73f8035dd377eed540d8">port</a> = atoi( start );
<a name="l00361"></a>00361    <span class="keywordflow">return</span> 0;
<a name="l00362"></a>00362 }
<a name="l00363"></a>00363 
<a name="l00364"></a><a class="code" href="a00021.html#af5c64e23533d55310336a6616922852b">00364</a> M_INLINE <span class="keywordtype">int</span> <a class="code" href="a00021.html#af5c64e23533d55310336a6616922852b">parse_server</a>( <a class="code" href="a00013.html">URIPARSECTX</a> *ctx, <span class="keywordtype">char</span> *ptr ,<span class="keywordtype">char</span> **next )
<a name="l00365"></a>00365 {
<a name="l00366"></a>00366   <span class="keywordtype">int</span> rt ;
<a name="l00367"></a>00367 
<a name="l00368"></a>00368   rt = <a class="code" href="a00021.html#aab2f681a85eb14cf468100ce68ed20ab">parse_userinfo</a>(ctx, ptr, next);
<a name="l00369"></a>00369   <span class="keywordflow">if</span> (rt &lt; 0) {
<a name="l00370"></a>00370     <span class="keywordflow">return</span> -1;
<a name="l00371"></a>00371   }
<a name="l00372"></a>00372   ptr = *next;
<a name="l00373"></a>00373   <span class="keywordflow">return</span> <a class="code" href="a00021.html#a66ff71abf545fe5b8177bd642e16653c">parse_hostport</a>( ctx, ptr, next);
<a name="l00374"></a>00374 }
<a name="l00375"></a>00375 
<a name="l00376"></a>00376 
<a name="l00377"></a><a class="code" href="a00021.html#a54749645383feb12ffbe62e168c7d5fa">00377</a> M_INLINE <span class="keywordtype">int</span> <a class="code" href="a00021.html#a54749645383feb12ffbe62e168c7d5fa">parse_authority</a>(  <a class="code" href="a00013.html">URIPARSECTX</a> *ctx, <span class="keywordtype">char</span> *ptr, <span class="keywordtype">char</span> **next )
<a name="l00378"></a>00378 {
<a name="l00379"></a>00379   <span class="keywordflow">if</span> (!<a class="code" href="a00021.html#af5c64e23533d55310336a6616922852b">parse_server</a>( ctx, ptr, next)) {
<a name="l00380"></a>00380     <span class="keywordflow">return</span> 0;
<a name="l00381"></a>00381   }
<a name="l00382"></a>00382   <span class="keywordflow">return</span> -1;
<a name="l00383"></a>00383 }
<a name="l00384"></a>00384 
<a name="l00385"></a>00385 
<a name="l00386"></a>00386 <span class="comment">//  scheme        = alpha *( alpha | digit | &quot;+&quot; | &quot;-&quot; | &quot;.&quot; ) &quot;:&quot;</span>
<a name="l00387"></a><a class="code" href="a00021.html#a39e605f0073f009c55127a0e9bd21707">00387</a> M_INLINE <span class="keywordtype">int</span> <a class="code" href="a00021.html#a39e605f0073f009c55127a0e9bd21707">parse_scheme</a>( <a class="code" href="a00013.html">URIPARSECTX</a> *ctx, <span class="keywordtype">char</span> *line, <span class="keywordtype">char</span> **next )
<a name="l00388"></a>00388 {
<a name="l00389"></a>00389     <span class="keywordtype">char</span> *start = line;
<a name="l00390"></a>00390 
<a name="l00391"></a>00391     <span class="keywordflow">if</span> (<a class="code" href="a00014.html#a3d3ebd9ca48c4ae7abae10d7b9f54763">is_alpha</a>( *line )) {
<a name="l00392"></a>00392        ++line;
<a name="l00393"></a>00393        <span class="keywordflow">while</span>( <a class="code" href="a00014.html#a283b46097df7193a0f62701ef8b65ebb">is_alphanum</a>( *line ) || *line == <span class="charliteral">&#39;+&#39;</span> || *line == <span class="charliteral">&#39;-&#39;</span> || *line == <span class="charliteral">&#39;.&#39;</span>) {
<a name="l00394"></a>00394          ++line;
<a name="l00395"></a>00395        }
<a name="l00396"></a>00396        <span class="keywordflow">if</span> ( *line == <span class="charliteral">&#39;:&#39;</span>) {
<a name="l00397"></a>00397            ctx-&gt;<a class="code" href="a00013.html#a247f676f1f828f9573fab8b77d18a162">rep</a>-&gt;<a class="code" href="a00012.html#a51cab48f1903d47847abd4fd2faa16dd">flags</a> |=  <a class="code" href="a00030.html#gae3a98cd8c957552df89bce7b42ad9692">URI_FLAGS_HAS_SCHEME</a>; 
<a name="l00398"></a>00398            ctx-&gt;<a class="code" href="a00013.html#a247f676f1f828f9573fab8b77d18a162">rep</a>-&gt;<a class="code" href="a00012.html#ac943b7c7bd534ddc1a84db68fdb9dbed">scheme</a> = <a class="code" href="a00021.html#abde5e24e4ee019b871ebe2a5575e270d">ctx_copy_string_raw</a>(ctx, start, line );
<a name="l00399"></a>00399            * next = line + 1;
<a name="l00400"></a>00400            <span class="keywordflow">return</span> 0;
<a name="l00401"></a>00401        }
<a name="l00402"></a>00402     } 
<a name="l00403"></a>00403 
<a name="l00404"></a>00404     <span class="keywordflow">return</span> -1;
<a name="l00405"></a>00405 }
<a name="l00406"></a>00406 
<a name="l00407"></a><a class="code" href="a00021.html#ad882bddea7e87fc45d69b807bb53d5ab">00407</a> M_INLINE <span class="keywordtype">int</span> <a class="code" href="a00021.html#ad882bddea7e87fc45d69b807bb53d5ab">parse_abs_path</a>( <a class="code" href="a00013.html">URIPARSECTX</a> *ctx, <span class="keywordtype">char</span> *ptr, <span class="keywordtype">char</span> **next )
<a name="l00408"></a>00408 {
<a name="l00409"></a>00409     <span class="keywordtype">char</span> *start;
<a name="l00410"></a>00410 
<a name="l00411"></a>00411     start = ptr;
<a name="l00412"></a>00412 
<a name="l00413"></a>00413     <span class="keywordflow">if</span> (*ptr == <span class="charliteral">&#39;/&#39;</span>) {
<a name="l00414"></a>00414       <a class="code" href="a00021.html#a4b4396f507fe125c822b3ca4042a41da">ctx_add_escaped_char</a>( ctx, <span class="charliteral">&#39;/&#39;</span>, 0 );
<a name="l00415"></a>00415       *next = ++ptr;
<a name="l00416"></a>00416     }
<a name="l00417"></a>00417     <span class="keywordflow">if</span> (<a class="code" href="a00021.html#a55e2a69ac69cfed87ca6c2dc94b41e07">parse_path_segments</a>( ctx, ptr, next ) &lt; 0) {
<a name="l00418"></a>00418       <span class="keywordflow">return</span> -1;
<a name="l00419"></a>00419     }
<a name="l00420"></a>00420     <span class="keywordflow">if</span> (*next != ptr) {
<a name="l00421"></a>00421            ctx-&gt;<a class="code" href="a00013.html#a247f676f1f828f9573fab8b77d18a162">rep</a>-&gt;<a class="code" href="a00012.html#a928a5e3c37023a0a884a703077924eeb">path_raw</a> = <a class="code" href="a00021.html#abde5e24e4ee019b871ebe2a5575e270d">ctx_copy_string_raw</a>(ctx, start, *next );
<a name="l00422"></a>00422            ctx-&gt;<a class="code" href="a00013.html#a247f676f1f828f9573fab8b77d18a162">rep</a>-&gt;<a class="code" href="a00012.html#a8fb5ba5e6bb70ec1b3599bdcaf813093">path</a> =  <a class="code" href="a00021.html#a0ad56df073d2ba27ea027e41469b3f9c">ctx_finish_escaped_string</a>(ctx); 
<a name="l00423"></a>00423     }
<a name="l00424"></a>00424     <span class="keywordflow">return</span> 0;
<a name="l00425"></a>00425 }
<a name="l00426"></a>00426 
<a name="l00427"></a>00427 <span class="comment">// authority [ abs_path ]</span>
<a name="l00428"></a><a class="code" href="a00021.html#af005921411390c1a063713542cc5e662">00428</a> M_INLINE <span class="keywordtype">int</span> <a class="code" href="a00021.html#af005921411390c1a063713542cc5e662">parse_net_path</a>( <a class="code" href="a00013.html">URIPARSECTX</a> *ctx, <span class="keywordtype">char</span> *ptr , <span class="keywordtype">char</span> **next )
<a name="l00429"></a>00429 {
<a name="l00430"></a>00430    <span class="keywordflow">if</span> (! <a class="code" href="a00021.html#a54749645383feb12ffbe62e168c7d5fa">parse_authority</a>( ctx, ptr, next )) {
<a name="l00431"></a>00431       ptr = *next;
<a name="l00432"></a>00432       <span class="keywordflow">if</span> (*ptr == <span class="charliteral">&#39;/&#39;</span>) {
<a name="l00433"></a>00433          <span class="keywordflow">return</span> <a class="code" href="a00021.html#ad882bddea7e87fc45d69b807bb53d5ab">parse_abs_path</a>( ctx, ptr, next );
<a name="l00434"></a>00434       }
<a name="l00435"></a>00435    }
<a name="l00436"></a>00436 
<a name="l00437"></a>00437    <span class="keywordflow">return</span> 0;
<a name="l00438"></a>00438 }
<a name="l00439"></a>00439 
<a name="l00440"></a><a class="code" href="a00021.html#ae6afcc5b19c364ba41ef076cde2f1467">00440</a> M_INLINE <span class="keywordtype">int</span> <a class="code" href="a00021.html#ae6afcc5b19c364ba41ef076cde2f1467">parse_uric_no_slash</a>( <a class="code" href="a00013.html">URIPARSECTX</a> *ctx, <span class="keywordtype">char</span> *ptr, <span class="keywordtype">char</span> **next )
<a name="l00441"></a>00441 {
<a name="l00442"></a>00442    <span class="keywordflow">if</span> (<a class="code" href="a00021.html#acce9ea7662290b5b285addb415153760">is_unreserved</a>( *ptr ) || *ptr == <span class="charliteral">&#39;;&#39;</span> || *ptr == <span class="charliteral">&#39;?&#39;</span> || *ptr == <span class="charliteral">&#39;:&#39;</span> || *ptr == <span class="charliteral">&#39;@&#39;</span> || *ptr == <span class="charliteral">&#39;&amp;&#39;</span>
<a name="l00443"></a>00443             || *ptr == <span class="charliteral">&#39;=&#39;</span> || *ptr == <span class="charliteral">&#39;+&#39;</span> || *ptr == <span class="charliteral">&#39;$&#39;</span> || *ptr == <span class="charliteral">&#39;,&#39;</span>) {
<a name="l00444"></a>00444      <a class="code" href="a00021.html#a4b4396f507fe125c822b3ca4042a41da">ctx_add_escaped_char</a>( ctx, *ptr, 0);
<a name="l00445"></a>00445      *next = ptr +1;
<a name="l00446"></a>00446      <span class="keywordflow">return</span> 0;
<a name="l00447"></a>00447    }    
<a name="l00448"></a>00448    <span class="keywordflow">return</span> <a class="code" href="a00021.html#a0b56a1f8c34732e7d34f6a26071196ff">parse_escaped</a>( ctx, ptr, next );
<a name="l00449"></a>00449 }
<a name="l00450"></a>00450 
<a name="l00451"></a>00451  
<a name="l00452"></a>00452 
<a name="l00453"></a><a class="code" href="a00021.html#a9d3fa2060cba0d40131cac8691492bbf">00453</a> <span class="keywordtype">int</span> <a class="code" href="a00021.html#a9d3fa2060cba0d40131cac8691492bbf">parse_opaque_part</a>( <a class="code" href="a00013.html">URIPARSECTX</a> *ctx, <span class="keywordtype">char</span> *ptr, <span class="keywordtype">char</span> **next )
<a name="l00454"></a>00454 {
<a name="l00455"></a>00455    <span class="keywordtype">char</span> *start = ptr;
<a name="l00456"></a>00456    <span class="keywordtype">int</span> rt;
<a name="l00457"></a>00457    <span class="keywordflow">if</span> ( (rt = <a class="code" href="a00021.html#ae6afcc5b19c364ba41ef076cde2f1467">parse_uric_no_slash</a>( ctx, ptr, next )) != 0 ) {
<a name="l00458"></a>00458      <span class="keywordflow">return</span> rt;
<a name="l00459"></a>00459    }
<a name="l00460"></a>00460    <span class="keywordflow">if</span> (<a class="code" href="a00021.html#adfb50d1059700bd12272e3a5fba61461">parse_uric_sequence</a>( ctx, ptr, next ) &lt; 0) {
<a name="l00461"></a>00461      <span class="keywordflow">return</span> -1;
<a name="l00462"></a>00462    }
<a name="l00463"></a>00463    ctx-&gt;<a class="code" href="a00013.html#a247f676f1f828f9573fab8b77d18a162">rep</a>-&gt;<a class="code" href="a00012.html#a51cab48f1903d47847abd4fd2faa16dd">flags</a> |= <a class="code" href="a00030.html#gab18d910ab6fe32e5e2bd49e138f1f1e5">URI_FLAGS_IS_OPAQUE</a>;  
<a name="l00464"></a>00464    ctx-&gt;<a class="code" href="a00013.html#a247f676f1f828f9573fab8b77d18a162">rep</a>-&gt;<a class="code" href="a00012.html#a7dc74378d1a475a10d1528d7ad4dd968">opaque_raw</a> = <a class="code" href="a00021.html#abde5e24e4ee019b871ebe2a5575e270d">ctx_copy_string_raw</a>(ctx, start, ptr );
<a name="l00465"></a>00465    ctx-&gt;<a class="code" href="a00013.html#a247f676f1f828f9573fab8b77d18a162">rep</a>-&gt;<a class="code" href="a00012.html#a591b8403463e8028851a7a84068672cf">opaque</a> =  <a class="code" href="a00021.html#a0ad56df073d2ba27ea027e41469b3f9c">ctx_finish_escaped_string</a>(ctx); 
<a name="l00466"></a>00466 
<a name="l00467"></a>00467 
<a name="l00468"></a>00468    <span class="keywordflow">return</span> 0;
<a name="l00469"></a>00469 }
<a name="l00470"></a>00470 
<a name="l00471"></a>00471 
<a name="l00472"></a><a class="code" href="a00021.html#a329ed8214b110b4c294f413f49cb9635">00472</a> <span class="keywordtype">int</span> <a class="code" href="a00021.html#a329ed8214b110b4c294f413f49cb9635">parse_hier_part</a>( <a class="code" href="a00013.html">URIPARSECTX</a> *ctx, <span class="keywordtype">char</span> *ptr , <span class="keywordtype">char</span> **next, <span class="keywordtype">int</span> parse_opaque)
<a name="l00473"></a>00473 {
<a name="l00474"></a>00474   <span class="keywordtype">char</span> *start;
<a name="l00475"></a>00475 
<a name="l00476"></a>00476   <span class="keywordflow">if</span> (ptr[0] == <span class="charliteral">&#39;/&#39;</span>) {
<a name="l00477"></a>00477     <span class="keywordflow">if</span> (ptr[1] == <span class="charliteral">&#39;/&#39;</span>) {
<a name="l00478"></a>00478       <span class="keywordflow">if</span> (<a class="code" href="a00021.html#af005921411390c1a063713542cc5e662">parse_net_path</a>( ctx, ptr + 2, next )) {
<a name="l00479"></a>00479         <span class="keywordflow">return</span> -1;
<a name="l00480"></a>00480       }
<a name="l00481"></a>00481     } <span class="keywordflow">else</span> {
<a name="l00482"></a>00482     <span class="comment">//ctx_add_escaped_char( ctx, &#39;/&#39;, 0 );</span>
<a name="l00483"></a>00483       <span class="keywordflow">if</span> (<a class="code" href="a00021.html#ad882bddea7e87fc45d69b807bb53d5ab">parse_abs_path</a>( ctx, ptr, next )) {
<a name="l00484"></a>00484         <span class="keywordflow">return</span> -1;
<a name="l00485"></a>00485       }
<a name="l00486"></a>00486     } 
<a name="l00487"></a>00487   } <span class="keywordflow">else</span> {
<a name="l00488"></a>00488     <span class="keywordflow">if</span> (parse_opaque) {
<a name="l00489"></a>00489        <span class="keywordflow">return</span> <a class="code" href="a00021.html#a9d3fa2060cba0d40131cac8691492bbf">parse_opaque_part</a>( ctx, ptr, next );
<a name="l00490"></a>00490     }
<a name="l00491"></a>00491     <span class="keywordflow">return</span> -1;
<a name="l00492"></a>00492   }
<a name="l00493"></a>00493 
<a name="l00494"></a>00494   ptr = *next;
<a name="l00495"></a>00495   <span class="keywordflow">if</span> (*ptr == <span class="charliteral">&#39;?&#39;</span>) {
<a name="l00496"></a>00496  
<a name="l00497"></a>00497     ptr ++;
<a name="l00498"></a>00498     start = ptr;
<a name="l00499"></a>00499     <span class="keywordflow">if</span> ( <a class="code" href="a00021.html#adfb50d1059700bd12272e3a5fba61461">parse_uric_sequence</a>( ctx, ptr, next ) == -1 ) {
<a name="l00500"></a>00500       <span class="keywordflow">return</span> -1;
<a name="l00501"></a>00501     }
<a name="l00502"></a>00502     ptr = *next;
<a name="l00503"></a>00503     ctx-&gt;<a class="code" href="a00013.html#a247f676f1f828f9573fab8b77d18a162">rep</a>-&gt;<a class="code" href="a00012.html#a93e6702c354c94b3157df02701827a2c">query_raw</a> = <a class="code" href="a00021.html#abde5e24e4ee019b871ebe2a5575e270d">ctx_copy_string_raw</a>(ctx, start, ptr );
<a name="l00504"></a>00504     ctx-&gt;<a class="code" href="a00013.html#a247f676f1f828f9573fab8b77d18a162">rep</a>-&gt;<a class="code" href="a00012.html#a398a57e4184218f02fc33b04da7819fa">query</a> =  <a class="code" href="a00021.html#a0ad56df073d2ba27ea027e41469b3f9c">ctx_finish_escaped_string</a>(ctx); 
<a name="l00505"></a>00505   }
<a name="l00506"></a>00506 
<a name="l00507"></a>00507   <span class="keywordflow">if</span> ( *ptr != <span class="charliteral">&#39;#&#39;</span> ) {
<a name="l00508"></a>00508     <span class="keywordflow">return</span> 0;
<a name="l00509"></a>00509   }
<a name="l00510"></a>00510 
<a name="l00511"></a>00511   ++ ptr;
<a name="l00512"></a>00512   start = ptr;
<a name="l00513"></a>00513   <span class="keywordflow">if</span> (<a class="code" href="a00021.html#adfb50d1059700bd12272e3a5fba61461">parse_uric_sequence</a>( ctx, ptr, next ) == -1) {
<a name="l00514"></a>00514     <span class="keywordflow">return</span> -1;
<a name="l00515"></a>00515   }
<a name="l00516"></a>00516   ptr = *next;
<a name="l00517"></a>00517   ctx-&gt;<a class="code" href="a00013.html#a247f676f1f828f9573fab8b77d18a162">rep</a>-&gt;<a class="code" href="a00012.html#a474ccc0167a309bffaa8339f55ba51ef">fragment_raw</a> = <a class="code" href="a00021.html#abde5e24e4ee019b871ebe2a5575e270d">ctx_copy_string_raw</a>(ctx, start, ptr );
<a name="l00518"></a>00518   ctx-&gt;<a class="code" href="a00013.html#a247f676f1f828f9573fab8b77d18a162">rep</a>-&gt;<a class="code" href="a00012.html#afb4b0def9276bead2a348bab74e1034e">fragment</a> =  <a class="code" href="a00021.html#a0ad56df073d2ba27ea027e41469b3f9c">ctx_finish_escaped_string</a>(ctx); 
<a name="l00519"></a>00519   
<a name="l00520"></a>00520   <span class="keywordflow">return</span> 0;
<a name="l00521"></a>00521 }
<a name="l00522"></a>00522 
<a name="l00523"></a><a class="code" href="a00030.html#gab9acb8adb11be6e657892d858f40e917">00523</a> <span class="keywordtype">int</span> <a class="code" href="a00030.html#gab9acb8adb11be6e657892d858f40e917">URI_parse</a>( <a class="code" href="a00012.html">URI</a> *url, <span class="keywordtype">char</span> *line )
<a name="l00524"></a>00524 {
<a name="l00525"></a>00525    <a class="code" href="a00030.html#ga8ff72430ab547d0151fc8c58c8039825">URI_init</a>( url );
<a name="l00526"></a>00526    <a class="code" href="a00013.html">URIPARSECTX</a> ctx;
<a name="l00527"></a>00527    <span class="keywordtype">char</span> *ptr,*next;
<a name="l00528"></a>00528    <span class="keywordtype">size_t</span> slen;
<a name="l00529"></a>00529 
<a name="l00530"></a>00530    ctx.<a class="code" href="a00013.html#a247f676f1f828f9573fab8b77d18a162">rep</a> = url;
<a name="l00531"></a>00531 
<a name="l00532"></a>00532    slen = strlen( line );
<a name="l00533"></a>00533    url-&gt;<a class="code" href="a00012.html#acae695b7cb9d303ce4180e0fa0ab44e0">cdata</a> = (<span class="keywordtype">char</span> *) malloc( slen );
<a name="l00534"></a>00534    <span class="keywordflow">if</span> (!url-&gt;<a class="code" href="a00012.html#acae695b7cb9d303ce4180e0fa0ab44e0">cdata</a>) {
<a name="l00535"></a>00535      <span class="keywordflow">goto</span> err;
<a name="l00536"></a>00536    }
<a name="l00537"></a>00537 
<a name="l00538"></a>00538    ctx.<a class="code" href="a00013.html#ab5eec79fbd87a3faddbe6c6e37da4e33">cdata_pos_off</a> = ctx.<a class="code" href="a00013.html#ab0bbce6c84fdc9b47d66720287845852">cdata_pos_start</a> = ctx.<a class="code" href="a00013.html#adb85398bbc31177e903ba48a431aabbd">cdata_pos</a> = url-&gt;<a class="code" href="a00012.html#acae695b7cb9d303ce4180e0fa0ab44e0">cdata</a>;
<a name="l00539"></a>00539 
<a name="l00540"></a>00540    url-&gt;<a class="code" href="a00012.html#a11ae40e294bcabbeb21d210fbc324a16">cdata_raw</a> = (<span class="keywordtype">char</span> *) malloc( slen );
<a name="l00541"></a>00541    <span class="keywordflow">if</span> (!url-&gt;<a class="code" href="a00012.html#a11ae40e294bcabbeb21d210fbc324a16">cdata_raw</a>) {
<a name="l00542"></a>00542      <span class="keywordflow">goto</span> err;
<a name="l00543"></a>00543    }
<a name="l00544"></a>00544 
<a name="l00545"></a>00545    url-&gt;<a class="code" href="a00012.html#a3dda8a91c57bac6e9db0edc60c0572e8">cdata_is_escaped</a> = (<span class="keywordtype">char</span> *) malloc( slen );
<a name="l00546"></a>00546    <span class="keywordflow">if</span> (!url-&gt;<a class="code" href="a00012.html#a3dda8a91c57bac6e9db0edc60c0572e8">cdata_is_escaped</a>) {
<a name="l00547"></a>00547      <span class="keywordflow">goto</span> err;
<a name="l00548"></a>00548    }
<a name="l00549"></a>00549    memset( url-&gt;<a class="code" href="a00012.html#a3dda8a91c57bac6e9db0edc60c0572e8">cdata_is_escaped</a>, 0, slen );
<a name="l00550"></a>00550    ctx.<a class="code" href="a00013.html#ab6c0fad059718b37ab69741ae5761f73">cdata_is_escaped_start</a> = url-&gt;<a class="code" href="a00012.html#a3dda8a91c57bac6e9db0edc60c0572e8">cdata_is_escaped</a>;
<a name="l00551"></a>00551 
<a name="l00552"></a>00552    ctx.<a class="code" href="a00013.html#aed0cfa54ff781d5f68562a02acbf3fba">cdata_raw_pos</a> = url-&gt;<a class="code" href="a00012.html#a11ae40e294bcabbeb21d210fbc324a16">cdata_raw</a>;
<a name="l00553"></a>00553 
<a name="l00554"></a>00554 
<a name="l00555"></a>00555    ptr = line;
<a name="l00556"></a>00556    <span class="keywordflow">if</span> (ptr[0] == <span class="charliteral">&#39;/&#39;</span>) {
<a name="l00557"></a>00557         <span class="keywordflow">if</span> ( <a class="code" href="a00021.html#a329ed8214b110b4c294f413f49cb9635">parse_hier_part</a>( &amp;ctx, ptr, &amp;next, 0) ) {
<a name="l00558"></a>00558           <span class="keywordflow">goto</span> err;
<a name="l00559"></a>00559         }
<a name="l00560"></a>00560    } <span class="keywordflow">else</span> {
<a name="l00561"></a>00561         <span class="keywordflow">if</span> (! <a class="code" href="a00021.html#a39e605f0073f009c55127a0e9bd21707">parse_scheme</a>( &amp;ctx, ptr, &amp;next )) {
<a name="l00562"></a>00562             ptr = next;
<a name="l00563"></a>00563             <span class="keywordflow">if</span> ( <a class="code" href="a00021.html#a329ed8214b110b4c294f413f49cb9635">parse_hier_part</a>( &amp;ctx, ptr, &amp;next, 1 ) ) {
<a name="l00564"></a>00564               <span class="keywordflow">goto</span> err;
<a name="l00565"></a>00565             }   
<a name="l00566"></a>00566         } <span class="keywordflow">else</span> {
<a name="l00567"></a>00567             <span class="keywordflow">if</span> ( <a class="code" href="a00021.html#a54749645383feb12ffbe62e168c7d5fa">parse_authority</a>( &amp;ctx, ptr, &amp;next )) {
<a name="l00568"></a>00568                <span class="keywordflow">goto</span> err;
<a name="l00569"></a>00569             }
<a name="l00570"></a>00570         }   
<a name="l00571"></a>00571    }
<a name="l00572"></a>00572 
<a name="l00573"></a>00573   <span class="keywordflow">if</span> (*next == <span class="charliteral">&#39;\0&#39;</span>) {
<a name="l00574"></a>00574     <span class="keywordflow">return</span> 0;
<a name="l00575"></a>00575   }
<a name="l00576"></a>00576 
<a name="l00577"></a>00577 err:
<a name="l00578"></a>00578   <a class="code" href="a00030.html#gab82397c63ee9a3456c6bdb8e109a007a">URI_free</a>( url );
<a name="l00579"></a>00579   <span class="keywordflow">return</span> -1;
<a name="l00580"></a>00580 }
<a name="l00581"></a>00581 
<a name="l00582"></a>00582 
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Oct 25 2011 01:17:12 for HTTP Parser and message builder / objects in plain C by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </small></address>
</body>
</html>
