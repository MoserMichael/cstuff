<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Simple tools for networking / objects in plain C: sock.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Simple tools for networking / objects in plain C&#160;<span id="projectnumber">Snapshot</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">sock.c File Reference</div>  </div>
</div>
<div class="contents">
<div class="textblock"><code>#include &lt;netinet/in.h&gt;</code><br/>
<code>#include &lt;netinet/tcp.h&gt;</code><br/>
<code>#include &lt;arpa/inet.h&gt;</code><br/>
<code>#include &lt;sys/select.h&gt;</code><br/>
<code>#include &lt;sys/ioctl.h&gt;</code><br/>
<code>#include &lt;sys/time.h&gt;</code><br/>
<code>#include &lt;sys/types.h&gt;</code><br/>
<code>#include &lt;sys/socket.h&gt;</code><br/>
<code>#include &lt;unistd.h&gt;</code><br/>
<code>#include &lt;stdio.h&gt;</code><br/>
<code>#include &lt;stdint.h&gt;</code><br/>
<code>#include &lt;stdlib.h&gt;</code><br/>
<code>#include &lt;string.h&gt;</code><br/>
<code>#include &lt;errno.h&gt;</code><br/>
<code>#include &quot;<a class="el" href="a00003_source.html">sock.h</a>&quot;</code><br/>
</div>
<p><a href="a00002_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00002.html#aa58093540ffae6b2fd5114af70ea9249">SOCK_init</a> (<a class="el" href="a00001.html">SOCKCTX</a> *ctx, int verbose, int flags)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">creates a socket and sets some options  <a href="#aa58093540ffae6b2fd5114af70ea9249"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00002.html#a691ca5d5947940ef7bb8e05f5f4381ee">SOCK_send_buffer_sizes</a> (<a class="el" href="a00001.html">SOCKCTX</a> *ctx, int read_buffer_size, int write_buffer_size)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">set read and write buffer sizes; a value of -1 for buffer size is ignored.  <a href="#a691ca5d5947940ef7bb8e05f5f4381ee"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00002.html#a9a6c6d2ae46cdab6fe52e285f9a8990d">SOCK_connect</a> (<a class="el" href="a00001.html">SOCKCTX</a> *ctx, void *addr, int addr_size, int connect_timeout)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">connects a sockets with timeout (in seconds)  <a href="#a9a6c6d2ae46cdab6fe52e285f9a8990d"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00002.html#a4d44efb92c4cd8cc45d2f7434d0f34bf">SOCK_recv_all</a> (<a class="el" href="a00001.html">SOCKCTX</a> *ctx, char *msg, size_t length, int read_timeout)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">read whe whole buffer from a socket with timeout (in seconds)  <a href="#a4d44efb92c4cd8cc45d2f7434d0f34bf"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00002.html#a29f9645369f83530169a0009c19ed35c">SOCK_recv</a> (<a class="el" href="a00001.html">SOCKCTX</a> *ctx, char *msg, size_t length, int read_timeout)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">read some data from a socket with timeout (in seconds)  <a href="#a29f9645369f83530169a0009c19ed35c"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00002.html#ac21bfc6d97caca5ed2efde6475992ae0">SOCK_send</a> (<a class="el" href="a00001.html">SOCKCTX</a> *ctx, void *bmsg, size_t length, int write_timeout)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">write whe whole buffer from a socket with timeout (in seconds)  <a href="#ac21bfc6d97caca5ed2efde6475992ae0"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00002.html#ad78589add776d85bd1c2e25a9d960eef">SOCK_close</a> (<a class="el" href="a00001.html">SOCKCTX</a> *ctx)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">close the socket  <a href="#ad78589add776d85bd1c2e25a9d960eef"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00002.html#aa4e7c6427b947269086042413e060ed3">SOCK_close_with_reset</a> (<a class="el" href="a00001.html">SOCKCTX</a> *ctx)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">ungraceful connection termination.  <a href="#aa4e7c6427b947269086042413e060ed3"></a><br/></td></tr>
</table>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="ad78589add776d85bd1c2e25a9d960eef"></a><!-- doxytag: member="sock.c::SOCK_close" ref="ad78589add776d85bd1c2e25a9d960eef" args="(SOCKCTX *ctx)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int SOCK_close </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00001.html">SOCKCTX</a> *&#160;</td>
          <td class="paramname"><em>ctx</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>close the socket </p>

<p>Definition at line <a class="el" href="a00002_source.html#l00318">318</a> of file <a class="el" href="a00002_source.html">sock.c</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="a00001.html#addcdd353858c7738ccde887e2fa48501">fd</a> != -1) {
    <span class="keywordflow">if</span> (close(ctx-&gt;<a class="code" href="a00001.html#addcdd353858c7738ccde887e2fa48501">fd</a>)) {
      <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="a00001.html#aaa34bd395f2c627e0497599095582550">verbose</a>) {
         fprintf(stderr,<span class="stringliteral">&quot;Close failed errno %d\n&quot;</span>, errno);
      }
    }
    ctx-&gt;<a class="code" href="a00001.html#addcdd353858c7738ccde887e2fa48501">fd</a> = -1;
    ctx-&gt;<a class="code" href="a00001.html#a5283ea4aa0d2447d230e37074a0589ef">connected</a> = 0;
  }
  <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="aa4e7c6427b947269086042413e060ed3"></a><!-- doxytag: member="sock.c::SOCK_close_with_reset" ref="aa4e7c6427b947269086042413e060ed3" args="(SOCKCTX *ctx)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int SOCK_close_with_reset </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00001.html">SOCKCTX</a> *&#160;</td>
          <td class="paramname"><em>ctx</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>ungraceful connection termination. </p>
<p>This function avoids TIME_WAIT when initiating closing of connection.</p>
<p>TIME_WAIT occurs, when the socket has been shut down properly; the application has sent FIN to the peer, and received an ACK for this message; the application has now sent the final last ACK to the peer; the connection is now in TIME_WAIT state and remains so for quite some time. Why? The last ACK might get lost, so TCP wants to make sure that no retransmissions of the last ACK are required.</p>
<p>For high performance servers this can mean that we will run out of socket handles.</p>
<p>The solution is for the client to terminate the connection ungracefully; instead of sending a FIN packet, the application can send out a RST (reset) packet, this will avoid the whole protocol of closing connections.</p>
<p>Here the SO_LINGER option is set with timeout of 0 prior to calling close; this results in sending out the RST packet / terminates the connection ungracefully.</p>
<p>Note that there is still a chance that the RST packet will get lost; in this we can only hope that the server will close it's side of the connection due to some connection idle timeout. </p>

<p>Definition at line <a class="el" href="a00002_source.html#l00332">332</a> of file <a class="el" href="a00002_source.html">sock.c</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keyword">struct </span>linger l;
  
  l.l_onoff = 1; l.l_linger = 0;

  <span class="keywordflow">if</span> (setsockopt( ctx-&gt;<a class="code" href="a00001.html#addcdd353858c7738ccde887e2fa48501">fd</a>, SOL_SOCKET, SO_LINGER, &amp;l, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> linger) )) {
      <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="a00001.html#aaa34bd395f2c627e0497599095582550">verbose</a>) {
       fprintf(stderr,<span class="stringliteral">&quot;Failed to set linger option. %d\n&quot;</span>, errno );
      }
  }

  <span class="keywordflow">return</span> <a class="code" href="a00002.html#ad78589add776d85bd1c2e25a9d960eef" title="close the socket">SOCK_close</a>( ctx );
}
</pre></div>
</div>
</div>
<a class="anchor" id="a9a6c6d2ae46cdab6fe52e285f9a8990d"></a><!-- doxytag: member="sock.c::SOCK_connect" ref="a9a6c6d2ae46cdab6fe52e285f9a8990d" args="(SOCKCTX *ctx, void *addr, int addr_size, int connect_timeout)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int SOCK_connect </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00001.html">SOCKCTX</a> *&#160;</td>
          <td class="paramname"><em>ctx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>addr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>addr_size</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>connect_timeout</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>connects a sockets with timeout (in seconds) </p>

<p>Definition at line <a class="el" href="a00002_source.html#l00096">96</a> of file <a class="el" href="a00002_source.html">sock.c</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> rt;
  fd_set wset,eset;
  <span class="keyword">struct </span>timeval tv;
  <span class="keywordtype">int</span> error = 0;
  <span class="keywordtype">int</span> len;
    
  <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="a00001.html#a5283ea4aa0d2447d230e37074a0589ef">connected</a>) {
    <span class="keywordflow">return</span> 0;
  }

  <span class="keywordflow">if</span> (addr != 0) {
     ctx-&gt;<a class="code" href="a00001.html#a3d6d0b0910922102ef30609abf8e9abf">addr</a> = malloc( addr_size );
     <span class="keywordflow">if</span> (!ctx-&gt;<a class="code" href="a00001.html#a3d6d0b0910922102ef30609abf8e9abf">addr</a>) {
       <span class="keywordflow">goto</span> err;
     }
     memcpy( ctx-&gt;<a class="code" href="a00001.html#a3d6d0b0910922102ef30609abf8e9abf">addr</a>, addr, addr_size );
     ctx-&gt;<a class="code" href="a00001.html#a090065b6dfa838ecdf5ca535d6befa24">addr_size</a> = addr_size;
  }

  <span class="keywordflow">if</span> (!ctx-&gt;<a class="code" href="a00001.html#a3d6d0b0910922102ef30609abf8e9abf">addr</a>) {
    <span class="keywordflow">goto</span> err;
  }

  <span class="keywordflow">do</span> {
    rt = connect( ctx-&gt;<a class="code" href="a00001.html#addcdd353858c7738ccde887e2fa48501">fd</a>, (<span class="keyword">struct</span> sockaddr *) ctx-&gt;<a class="code" href="a00001.html#a3d6d0b0910922102ef30609abf8e9abf">addr</a>, ctx-&gt;<a class="code" href="a00001.html#a090065b6dfa838ecdf5ca535d6befa24">addr_size</a> );
  } <span class="keywordflow">while</span>( rt == -1 &amp;&amp; errno == EINTR);

  <span class="keywordflow">if</span> (rt == -1) {


<span class="preprocessor">#if 0</span>
<span class="preprocessor"></span>     <span class="keywordflow">if</span> (errno != EINPROGRESS) {
        <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="a00001.html#aaa34bd395f2c627e0497599095582550">verbose</a>) {
          fprintf(stderr,<span class="stringliteral">&quot;Connect syscall failed. %d\n&quot;</span>, errno );
        }
        <span class="keywordflow">goto</span> err;
     }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
     FD_ZERO(&amp;wset);
     FD_SET(ctx-&gt;<a class="code" href="a00001.html#addcdd353858c7738ccde887e2fa48501">fd</a>,&amp;wset);
     eset = wset;

     tv.tv_sec = connect_timeout;
     tv.tv_usec = 0;

     <span class="keywordflow">do</span> {
       rt = select( ctx-&gt;<a class="code" href="a00001.html#addcdd353858c7738ccde887e2fa48501">fd</a> + 1, 0, &amp;wset, &amp;eset, &amp;tv ); 
     } <span class="keywordflow">while</span>( rt == -1 &amp;&amp; errno == EINTR);
     
     <span class="keywordflow">if</span> (rt &lt;= 0) {
        <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="a00001.html#aaa34bd395f2c627e0497599095582550">verbose</a>) {
          fprintf(stderr,<span class="stringliteral">&quot;Connect timed out. %d\n&quot;</span>, errno );
        }
        <span class="keywordflow">goto</span> err;
     }

     <span class="keywordflow">if</span> (FD_ISSET( ctx-&gt;<a class="code" href="a00001.html#addcdd353858c7738ccde887e2fa48501">fd</a>, &amp;wset) ||  FD_ISSET( ctx-&gt;<a class="code" href="a00001.html#addcdd353858c7738ccde887e2fa48501">fd</a>, &amp;eset)) {
       len = <span class="keyword">sizeof</span>(error);
       error = 0;
       <span class="keywordflow">if</span> (getsockopt( ctx-&gt;<a class="code" href="a00001.html#addcdd353858c7738ccde887e2fa48501">fd</a>, SOL_SOCKET, SO_ERROR, &amp;error, (socklen_t *) &amp;len ) || error) {
         <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="a00001.html#aaa34bd395f2c627e0497599095582550">verbose</a>) {
           fprintf(stderr,<span class="stringliteral">&quot;Connect socket error. %d errno %d\n&quot;</span>, error, errno );
         }
         <span class="keywordflow">goto</span> err;
       }
     }

     <span class="keywordflow">if</span> (! FD_ISSET( ctx-&gt;<a class="code" href="a00001.html#addcdd353858c7738ccde887e2fa48501">fd</a>, &amp;wset)) {
         <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="a00001.html#aaa34bd395f2c627e0497599095582550">verbose</a>) {
           fprintf(stderr,<span class="stringliteral">&quot;Still not connected. errno %d\n&quot;</span>, errno );
         }
         <span class="keywordflow">goto</span> err;
     }
  }


  ctx-&gt;<a class="code" href="a00001.html#a5283ea4aa0d2447d230e37074a0589ef">connected</a> = 1;
  <span class="keywordflow">return</span> 0;

err:
  <a class="code" href="a00002.html#ad78589add776d85bd1c2e25a9d960eef" title="close the socket">SOCK_close</a>(ctx);
  <span class="keywordflow">return</span> -1;
}
</pre></div>
</div>
</div>
<a class="anchor" id="aa58093540ffae6b2fd5114af70ea9249"></a><!-- doxytag: member="sock.c::SOCK_init" ref="aa58093540ffae6b2fd5114af70ea9249" args="(SOCKCTX *ctx, int verbose, int flags)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int SOCK_init </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00001.html">SOCKCTX</a> *&#160;</td>
          <td class="paramname"><em>ctx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>verbose</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>flags</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>creates a socket and sets some options </p>

<p>Definition at line <a class="el" href="a00002_source.html#l00023">23</a> of file <a class="el" href="a00002_source.html">sock.c</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> arg;
  <span class="keyword">struct </span>linger l;

  ctx-&gt;<a class="code" href="a00001.html#aaa34bd395f2c627e0497599095582550">verbose</a> = verbose;
  ctx-&gt;<a class="code" href="a00001.html#a5283ea4aa0d2447d230e37074a0589ef">connected</a> = 0;

  ctx-&gt;<a class="code" href="a00001.html#a3d6d0b0910922102ef30609abf8e9abf">addr</a> = 0;
  ctx-&gt;<a class="code" href="a00001.html#a090065b6dfa838ecdf5ca535d6befa24">addr_size</a> = 0;

  ctx-&gt;<a class="code" href="a00001.html#addcdd353858c7738ccde887e2fa48501">fd</a> = socket( PF_INET, SOCK_STREAM, 0 );
  <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="a00001.html#addcdd353858c7738ccde887e2fa48501">fd</a> == -1) {
     <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="a00001.html#aaa34bd395f2c627e0497599095582550">verbose</a>) {
       fprintf(stderr, <span class="stringliteral">&quot;Failed to create socket %d\n&quot;</span>, errno);
     }
     <span class="keywordflow">return</span> -1;
  }

  arg = 0;
  <span class="keywordflow">if</span> (ioctl( ctx-&gt;<a class="code" href="a00001.html#addcdd353858c7738ccde887e2fa48501">fd</a>, FIONBIO, &amp;arg ) ) {
     <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="a00001.html#aaa34bd395f2c627e0497599095582550">verbose</a>) {
       fprintf(stderr, <span class="stringliteral">&quot;Failed to make socket non blocking errno %d\n&quot;</span>, errno);
     }
  }

  <span class="keywordflow">if</span> ((flags &amp; <a class="code" href="a00003.html#a387cd63d9202db79a473a4312e50a6d0">SOCKCTX_FLAGS_NAGLE_ON</a>) == 0) {  
    arg = 1;
    <span class="keywordflow">if</span> (setsockopt( ctx-&gt;<a class="code" href="a00001.html#addcdd353858c7738ccde887e2fa48501">fd</a>, IPPROTO_TCP, TCP_NODELAY, &amp;arg, <span class="keyword">sizeof</span>(arg) ) ) {
       <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="a00001.html#aaa34bd395f2c627e0497599095582550">verbose</a>) {
         fprintf(stderr,<span class="stringliteral">&quot;Failed to set nodelay option (disable nagle algorithm failed). errno %d\n&quot;</span>,errno);
       }    
    }
  }

  ctx-&gt;<a class="code" href="a00001.html#a21ecb44f25561d43dd4b154348562d6a">close_on_peer_close</a> = 1; 
  <span class="keywordflow">if</span> (flags &amp; <a class="code" href="a00003.html#a4e5ab8d07bf7233fe5358f74f89192d0">SOCKTCX_FLAGS_DONT_CLOSE_ON_PEER_CLOSE</a>) {
    l.l_onoff = 1; l.l_linger = <a class="code" href="a00003.html#a3adf1d96e791aba989b3bcd0ff855d44">LINGER_OPTION_VALUE</a>;
    <span class="keywordflow">if</span> (setsockopt( ctx-&gt;<a class="code" href="a00001.html#addcdd353858c7738ccde887e2fa48501">fd</a>, SOL_SOCKET, SO_LINGER, &amp;l, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> linger) )) {
      <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="a00001.html#aaa34bd395f2c627e0497599095582550">verbose</a>) {
       fprintf(stderr,<span class="stringliteral">&quot;Failed to set linger option. %d\n&quot;</span>, errno );
      }
    }
    ctx-&gt;<a class="code" href="a00001.html#a21ecb44f25561d43dd4b154348562d6a">close_on_peer_close</a> = 0; 
  }

  <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a29f9645369f83530169a0009c19ed35c"></a><!-- doxytag: member="sock.c::SOCK_recv" ref="a29f9645369f83530169a0009c19ed35c" args="(SOCKCTX *ctx, char *msg, size_t length, int read_timeout)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int SOCK_recv </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00001.html">SOCKCTX</a> *&#160;</td>
          <td class="paramname"><em>ctx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&#160;</td>
          <td class="paramname"><em>msg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>length</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>read_timeout</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>read some data from a socket with timeout (in seconds) </p>

<p>Definition at line <a class="el" href="a00002_source.html#l00201">201</a> of file <a class="el" href="a00002_source.html">sock.c</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> rt;
  fd_set rset;
  <span class="keyword">struct </span>timeval tv;
     
retry:
     <span class="keywordflow">do</span> {
       rt = recv( ctx-&gt;<a class="code" href="a00001.html#addcdd353858c7738ccde887e2fa48501">fd</a>, msg, length, 0 );
     } <span class="keywordflow">while</span>( rt == -1 &amp;&amp; errno == EINTR );

     <span class="keywordflow">if</span> (rt == -1) {
          
        <span class="keywordflow">if</span> (errno != EAGAIN) {
           <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="a00001.html#aaa34bd395f2c627e0497599095582550">verbose</a>) {
             fprintf(stderr,<span class="stringliteral">&quot;recv failed errno %d\n&quot;</span>, errno );
           }
           <span class="keywordflow">goto</span> err;
        }

        FD_ZERO(&amp;rset);
        FD_SET(ctx-&gt;<a class="code" href="a00001.html#addcdd353858c7738ccde887e2fa48501">fd</a>,&amp;rset);

        tv.tv_sec = read_timeout;
        tv.tv_usec = 0;

        <span class="keywordflow">do</span> {
          rt = select( ctx-&gt;<a class="code" href="a00001.html#addcdd353858c7738ccde887e2fa48501">fd</a> + 1, &amp;rset, 0, 0, &amp;tv ); 
        } <span class="keywordflow">while</span>( rt == -1 &amp;&amp; errno == EINTR);
        

        <span class="keywordflow">if</span> (rt == -1) {
          <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="a00001.html#aaa34bd395f2c627e0497599095582550">verbose</a>) {
            fprintf(stderr, <span class="stringliteral">&quot;select failed. %d\n&quot;</span>, errno );
          }
        }
     
        <span class="keywordflow">if</span> (rt == 0) {
           <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="a00001.html#aaa34bd395f2c627e0497599095582550">verbose</a>) {
             fprintf(stderr,<span class="stringliteral">&quot;read timed out\n&quot;</span> );
           }
           <span class="keywordflow">goto</span> err;
        }

        <span class="keywordflow">if</span> (rt == 1) {
           <span class="keywordflow">goto</span> retry;
        }

     }

   <span class="keywordflow">if</span> (rt == 0 &amp;&amp; ctx-&gt;<a class="code" href="a00001.html#a21ecb44f25561d43dd4b154348562d6a">close_on_peer_close</a>  ) {
      <a class="code" href="a00002.html#ad78589add776d85bd1c2e25a9d960eef" title="close the socket">SOCK_close</a>( ctx );
   }
   <span class="keywordflow">return</span> rt;

err:
   <span class="keywordflow">return</span> -1;
}        
</pre></div>
</div>
</div>
<a class="anchor" id="a4d44efb92c4cd8cc45d2f7434d0f34bf"></a><!-- doxytag: member="sock.c::SOCK_recv_all" ref="a4d44efb92c4cd8cc45d2f7434d0f34bf" args="(SOCKCTX *ctx, char *msg, size_t length, int read_timeout)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int SOCK_recv_all </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00001.html">SOCKCTX</a> *&#160;</td>
          <td class="paramname"><em>ctx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&#160;</td>
          <td class="paramname"><em>msg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>length</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>read_timeout</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>read whe whole buffer from a socket with timeout (in seconds) </p>

<p>Definition at line <a class="el" href="a00002_source.html#l00184">184</a> of file <a class="el" href="a00002_source.html">sock.c</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keywordtype">size_t</span> pos;
  <span class="keywordtype">int</span> rt;


  <span class="keywordflow">for</span>(pos = 0; pos &lt; length; ) {
      rt = <a class="code" href="a00002.html#a29f9645369f83530169a0009c19ed35c" title="read some data from a socket with timeout (in seconds)">SOCK_recv</a>( ctx, msg, length, read_timeout );
      <span class="keywordflow">if</span> (rt &lt;= 0) {
        <span class="keywordflow">return</span> -1;
      }
      pos += rt;
  }
  <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ac21bfc6d97caca5ed2efde6475992ae0"></a><!-- doxytag: member="sock.c::SOCK_send" ref="ac21bfc6d97caca5ed2efde6475992ae0" args="(SOCKCTX *ctx, void *bmsg, size_t length, int write_timeout)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int SOCK_send </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00001.html">SOCKCTX</a> *&#160;</td>
          <td class="paramname"><em>ctx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>bmsg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>length</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>write_timeout</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>write whe whole buffer from a socket with timeout (in seconds) </p>

<p>Definition at line <a class="el" href="a00002_source.html#l00261">261</a> of file <a class="el" href="a00002_source.html">sock.c</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> rt;
  <span class="keywordtype">size_t</span> pos;
  fd_set wset;
  <span class="keyword">struct </span>timeval tv;
  <span class="keywordtype">char</span> *msg = bmsg;

  <span class="keywordflow">for</span>( pos = 0; pos &lt; length; ) {

     <span class="keywordflow">do</span> {
       rt = send( ctx-&gt;<a class="code" href="a00001.html#addcdd353858c7738ccde887e2fa48501">fd</a>, msg + pos, length - pos, 0 );
     } <span class="keywordflow">while</span>( rt == -1 &amp;&amp; errno == EINTR );

     <span class="keywordflow">if</span> (rt == -1) {
          
        <span class="keywordflow">if</span> (errno != EAGAIN) {
           <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="a00001.html#aaa34bd395f2c627e0497599095582550">verbose</a>) {
             fprintf(stderr,<span class="stringliteral">&quot;send failed errno %d\n&quot;</span>, errno );
           }
           <span class="keywordflow">goto</span> err;
        }

        FD_ZERO(&amp;wset);
        FD_SET(ctx-&gt;<a class="code" href="a00001.html#addcdd353858c7738ccde887e2fa48501">fd</a>,&amp;wset);

        tv.tv_sec = write_timeout;
        tv.tv_usec = 0;

        <span class="keywordflow">do</span> {
          rt = select( ctx-&gt;<a class="code" href="a00001.html#addcdd353858c7738ccde887e2fa48501">fd</a> + 1, 0, &amp;wset, 0, &amp;tv ); 
        } <span class="keywordflow">while</span>( rt == -1 &amp;&amp; errno == EINTR);
        

        <span class="keywordflow">if</span> (rt == -1) {
          <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="a00001.html#aaa34bd395f2c627e0497599095582550">verbose</a>) {
            fprintf(stderr, <span class="stringliteral">&quot;select failed. %d\n&quot;</span>, errno );
          }
        }
     
        <span class="keywordflow">if</span> (rt == 0) {
           <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="a00001.html#aaa34bd395f2c627e0497599095582550">verbose</a>) {
             fprintf(stderr,<span class="stringliteral">&quot;send timed out\n&quot;</span> );
           }
           <span class="keywordflow">goto</span> err;
        }

     }

     pos += rt;
   }
   <span class="keywordflow">return</span> 0;

err:
   <span class="keywordflow">return</span> -1;
}        
</pre></div>
</div>
</div>
<a class="anchor" id="a691ca5d5947940ef7bb8e05f5f4381ee"></a><!-- doxytag: member="sock.c::SOCK_send_buffer_sizes" ref="a691ca5d5947940ef7bb8e05f5f4381ee" args="(SOCKCTX *ctx, int read_buffer_size, int write_buffer_size)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int SOCK_send_buffer_sizes </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00001.html">SOCKCTX</a> *&#160;</td>
          <td class="paramname"><em>ctx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>read_buffer_size</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>write_buffer_size</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>set read and write buffer sizes; a value of -1 for buffer size is ignored. </p>

<p>Definition at line <a class="el" href="a00002_source.html#l00073">73</a> of file <a class="el" href="a00002_source.html">sock.c</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> val;
  <span class="keywordflow">if</span> (read_buffer_size &gt; 0) {
    val = read_buffer_size;
    <span class="keywordflow">if</span> (setsockopt( ctx-&gt;<a class="code" href="a00001.html#addcdd353858c7738ccde887e2fa48501">fd</a>, SOL_SOCKET, SO_RCVBUF, &amp;val, <span class="keyword">sizeof</span>(val) )) {
      fprintf(stderr,<span class="stringliteral">&quot;Failed to set receive buffer size to %d\n&quot;</span>,val);
      <span class="keywordflow">return</span> -1;
    }
  }
  
  <span class="keywordflow">if</span> (write_buffer_size &gt; 0) {
    val = write_buffer_size;
    <span class="keywordflow">if</span> (setsockopt( ctx-&gt;<a class="code" href="a00001.html#addcdd353858c7738ccde887e2fa48501">fd</a>, SOL_SOCKET, SO_SNDBUF, &amp;val, <span class="keyword">sizeof</span>(val) )) {
      fprintf(stderr,<span class="stringliteral">&quot;Failed to set send buffer size to %d\n&quot;</span>,val);
      <span class="keywordflow">return</span> -1;
    }
  }
  <span class="keywordflow">return</span> 0;  

}
</pre></div>
</div>
</div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Aug 23 2011 18:31:28 for Simple tools for networking / objects in plain C by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </small></address>
</body>
</html>
