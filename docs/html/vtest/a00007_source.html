<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Simple XUnit test library / objects in plain C: vtest.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Simple XUnit test library / objects in plain C&#160;<span id="projectnumber">Snapshot</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">vtest.c</div>  </div>
</div>
<div class="contents">
<a href="a00007.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* Copyright (c) Michael Moser (2011) . 3-clause BSD License applies */</span>
<a name="l00002"></a>00002 
<a name="l00003"></a>00003 
<a name="l00004"></a>00004 
<a name="l00005"></a>00005 <span class="preprocessor">#include &quot;<a class="code" href="a00008.html">vtest.h</a>&quot;</span>
<a name="l00006"></a>00006 <span class="preprocessor">#include &quot;<a class="code" href="a00010.html">vtestrunner.h</a>&quot;</span>
<a name="l00007"></a>00007 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00008"></a>00008 <span class="preprocessor">#include &lt;malloc.h&gt;</span>
<a name="l00009"></a>00009 
<a name="l00010"></a>00010 <span class="preprocessor">#ifdef WIN32</span>
<a name="l00011"></a>00011 <span class="preprocessor"></span><span class="preprocessor">#include &lt;windows.h&gt;</span>
<a name="l00012"></a>00012 <span class="preprocessor">#endif</span>
<a name="l00013"></a>00013 <span class="preprocessor"></span>
<a name="l00014"></a>00014 <span class="comment"></span>
<a name="l00015"></a>00015 <span class="comment">/**</span>
<a name="l00016"></a>00016 <span class="comment"></span>
<a name="l00017"></a>00017 <span class="comment"> @mainpage</span>
<a name="l00018"></a>00018 <span class="comment"></span>
<a name="l00019"></a>00019 <span class="comment"> All this is a very small XUnit type testing framework.</span>
<a name="l00020"></a>00020 <span class="comment"></span>
<a name="l00021"></a>00021 <span class="comment"> Usage is explained in example file</span>
<a name="l00022"></a>00022 <span class="comment"></span>
<a name="l00023"></a>00023 <span class="comment"> @example example.c</span>
<a name="l00024"></a>00024 <span class="comment">*/</span>
<a name="l00025"></a>00025 
<a name="l00026"></a><a class="code" href="a00007.html#a53a3558c2850ac9d96eeb795fbfc70c0">00026</a> <a class="code" href="a00002.html">VTEST_RUNNER_IMPL</a> * <a class="code" href="a00007.html#a53a3558c2850ac9d96eeb795fbfc70c0">vtest_impl</a>;
<a name="l00027"></a><a class="code" href="a00007.html#a1fab7003576575cdfd86da7a19ae87a2">00027</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="a00007.html#a1fab7003576575cdfd86da7a19ae87a2">g_suite_name</a>;
<a name="l00028"></a>00028 
<a name="l00029"></a>00029 <span class="preprocessor">#ifdef WIN32</span>
<a name="l00030"></a>00030 <span class="preprocessor"></span>
<a name="l00031"></a>00031 <span class="keyword">typedef</span> BOOL (WINAPI *PIsDebuggerPresent)(void);
<a name="l00032"></a>00032 
<a name="l00033"></a>00033 BOOL DynIsDebuggerPresent(<span class="keywordtype">void</span>)
<a name="l00034"></a>00034 {
<a name="l00035"></a>00035         PIsDebuggerPresent isDeb;
<a name="l00036"></a>00036         CHAR K32Path[ MAX_PATH ];
<a name="l00037"></a>00037         HINSTANCE hK32;
<a name="l00038"></a>00038         BOOL Rc;
<a name="l00039"></a>00039 
<a name="l00040"></a>00040         Rc = FALSE;
<a name="l00041"></a>00041         GetSystemDirectory( K32Path, MAX_PATH );
<a name="l00042"></a>00042         strcat(K32Path,<span class="stringliteral">&quot;\\&quot;</span>);
<a name="l00043"></a>00043         strcat( K32Path, <span class="stringliteral">&quot;KERNEL32.DLL&quot;</span> );
<a name="l00044"></a>00044 
<a name="l00045"></a>00045         hK32 = LoadLibrary( K32Path );
<a name="l00046"></a>00046         <span class="keywordflow">if</span>( hK32 != NULL ) {
<a name="l00047"></a>00047                 isDeb = (PIsDebuggerPresent) GetProcAddress(hK32,<span class="stringliteral">&quot;IsDebuggerPresent&quot;</span>);
<a name="l00048"></a>00048                 <span class="keywordflow">if</span>(isDeb != NULL) {
<a name="l00049"></a>00049                         Rc = isDeb();
<a name="l00050"></a>00050                 }
<a name="l00051"></a>00051                 FreeLibrary( hK32 );
<a name="l00052"></a>00052         }
<a name="l00053"></a>00053 
<a name="l00054"></a>00054         <span class="keywordflow">return</span> Rc;
<a name="l00055"></a>00055 }
<a name="l00056"></a>00056 <span class="preprocessor">#endif</span>
<a name="l00057"></a>00057 <span class="preprocessor"></span>
<a name="l00058"></a><a class="code" href="a00008.html#ac238eb93c68c155eca5ada030eaeaec9">00058</a> <span class="keywordtype">void</span> <a class="code" href="a00007.html#ac238eb93c68c155eca5ada030eaeaec9">VFAIL</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *cond, <span class="keyword">const</span> <span class="keywordtype">char</span> *file,<span class="keywordtype">int</span> line)
<a name="l00059"></a>00059 {
<a name="l00060"></a>00060         vtest_impl-&gt;<a class="code" href="a00002.html#a2242678dd75ca03df88bb28f311ea17a">results</a>( vtest_impl-&gt;<a class="code" href="a00002.html#a90804fc11deef7b08763e47e01a9e6d2">scope_fail</a>, 
<a name="l00061"></a>00061                                                  vtest_impl-&gt;<a class="code" href="a00002.html#a82335d40bafedf6ed3df5bb2c2ca63a7">suite</a>-&gt;<a class="code" href="a00004.html#a606e0fc75c44a092aeb4ce79dc66da4c">name</a>, 
<a name="l00062"></a>00062                                                  vtest_impl-&gt;<a class="code" href="a00002.html#ad9a7903a319ed14b62fb2de303e6f5b9">test</a> ? vtest_impl-&gt;<a class="code" href="a00002.html#ad9a7903a319ed14b62fb2de303e6f5b9">test</a>-&gt;<a class="code" href="a00003.html#aedbd326bc39dd559d329cb4610da93d4">name</a> : 0,
<a name="l00063"></a>00063                                                  0, 
<a name="l00064"></a>00064                                                  cond, file, line);
<a name="l00065"></a>00065 
<a name="l00066"></a>00066         vtest_impl-&gt;<a class="code" href="a00002.html#a85901f9cda6b2b7ce0a101cda31d9974">current_test_state</a> = 0;
<a name="l00067"></a>00067 
<a name="l00068"></a>00068 <span class="preprocessor">#ifdef WIN32</span>
<a name="l00069"></a>00069 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (DynIsDebuggerPresent()) {
<a name="l00070"></a>00070                 DebugBreak();   
<a name="l00071"></a>00071         }
<a name="l00072"></a>00072 <span class="preprocessor">#endif</span>
<a name="l00073"></a>00073 <span class="preprocessor"></span>
<a name="l00074"></a>00074 }
<a name="l00075"></a>00075 
<a name="l00076"></a>00076 
<a name="l00077"></a><a class="code" href="a00007.html#a1513dea154603f49cb0d46e50659602b">00077</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="a00007.html#a1513dea154603f49cb0d46e50659602b">parse_suite_name</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *line, <span class="keywordtype">char</span> **suite_name,<span class="keywordtype">int</span> *len)
<a name="l00078"></a>00078 {
<a name="l00079"></a>00079         <span class="keyword">const</span> <span class="keywordtype">char</span> *tmp = line;
<a name="l00080"></a>00080         <span class="keywordtype">char</span> *next;
<a name="l00081"></a>00081         
<a name="l00082"></a>00082         *suite_name = (<span class="keywordtype">char</span> *) line;
<a name="l00083"></a>00083         next = strchr(tmp,<span class="charliteral">&#39;/&#39;</span>);
<a name="l00084"></a>00084 
<a name="l00085"></a>00085         <span class="keywordflow">if</span> (next) {
<a name="l00086"></a>00086                 *len = next - tmp;
<a name="l00087"></a>00087         } <span class="keywordflow">else</span> {
<a name="l00088"></a>00088                 *len = strlen(line);
<a name="l00089"></a>00089         }
<a name="l00090"></a>00090 
<a name="l00091"></a>00091         <span class="keywordflow">return</span> 1;
<a name="l00092"></a>00092 
<a name="l00093"></a>00093 }
<a name="l00094"></a>00094 
<a name="l00095"></a><a class="code" href="a00007.html#adfa4d68daca4820097c72d87bb3c0bc0">00095</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="a00007.html#adfa4d68daca4820097c72d87bb3c0bc0">parse_next_test_name</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *line, <span class="keywordtype">char</span> **test_name, <span class="keywordtype">int</span> *len, <span class="keywordtype">char</span> **last_pos)
<a name="l00096"></a>00096 {
<a name="l00097"></a>00097         <span class="keyword">const</span> <span class="keywordtype">char</span> *next;
<a name="l00098"></a>00098 
<a name="l00099"></a>00099         <span class="keywordflow">if</span> (*last_pos == 0) {
<a name="l00100"></a>00100                 *last_pos = strchr(line,<span class="charliteral">&#39;/&#39;</span>);
<a name="l00101"></a>00101                 <span class="keywordflow">if</span> (*last_pos == 0) {
<a name="l00102"></a>00102                         <span class="keywordflow">return</span> 0;
<a name="l00103"></a>00103                 }
<a name="l00104"></a>00104                 *last_pos += 1;
<a name="l00105"></a>00105         } <span class="keywordflow">else</span> {
<a name="l00106"></a>00106                 <span class="keywordflow">if</span> (**last_pos != <span class="charliteral">&#39;,&#39;</span>) {
<a name="l00107"></a>00107                         <span class="keywordflow">return</span> 0;
<a name="l00108"></a>00108                 }
<a name="l00109"></a>00109                 *last_pos = *last_pos + 1;
<a name="l00110"></a>00110         }
<a name="l00111"></a>00111 
<a name="l00112"></a>00112         <span class="keywordflow">if</span> (**last_pos == <span class="charliteral">&#39;\0&#39;</span>) {
<a name="l00113"></a>00113                 <span class="keywordflow">return</span> 0;
<a name="l00114"></a>00114         }
<a name="l00115"></a>00115 
<a name="l00116"></a>00116         next = strchr( *last_pos, <span class="charliteral">&#39;,&#39;</span>);
<a name="l00117"></a>00117 
<a name="l00118"></a>00118         *test_name = *last_pos;
<a name="l00119"></a>00119         <span class="keywordflow">if</span> (next) {
<a name="l00120"></a>00120                 *len = next - *last_pos;
<a name="l00121"></a>00121         } <span class="keywordflow">else</span> {
<a name="l00122"></a>00122                 *len = strlen(*last_pos);
<a name="l00123"></a>00123                 next = *last_pos + *len;
<a name="l00124"></a>00124         }
<a name="l00125"></a>00125         *last_pos = (<span class="keywordtype">char</span> *) next;
<a name="l00126"></a>00126         <span class="keywordflow">return</span> 1;
<a name="l00127"></a>00127 }
<a name="l00128"></a>00128 
<a name="l00129"></a>00129 
<a name="l00130"></a>00130 <span class="comment">/* do we run the given suite, given the current command line */</span>
<a name="l00131"></a><a class="code" href="a00007.html#ab8c1dd9c6da0bf795cc70a1feeef6292">00131</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="a00007.html#ab8c1dd9c6da0bf795cc70a1feeef6292">VTEST_is_run_suite</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *suite_name, <span class="keywordtype">char</span> *argv[], <span class="keywordtype">int</span> argc)
<a name="l00132"></a>00132 {
<a name="l00133"></a>00133         <span class="keywordtype">int</span> i;
<a name="l00134"></a>00134         <span class="keywordtype">char</span> *tmp_suite_name;
<a name="l00135"></a>00135         <span class="keywordtype">int</span> suite_name_len;
<a name="l00136"></a>00136         
<a name="l00137"></a>00137         <span class="keywordflow">if</span> (!argv || !argc) {
<a name="l00138"></a>00138                 <span class="keywordflow">return</span> 1;
<a name="l00139"></a>00139         }
<a name="l00140"></a>00140 
<a name="l00141"></a>00141         <span class="keywordflow">for</span>(i = 0; i &lt; argc; i++) {
<a name="l00142"></a>00142                 
<a name="l00143"></a>00143                 <span class="keywordflow">if</span> (<a class="code" href="a00007.html#a1513dea154603f49cb0d46e50659602b">parse_suite_name</a>(argv[i],&amp;tmp_suite_name, &amp;suite_name_len)) {
<a name="l00144"></a>00144                         <span class="keywordflow">if</span> (strlen(suite_name) == (<span class="keywordtype">size_t</span>) suite_name_len) {
<a name="l00145"></a>00145                                 <span class="keywordflow">if</span> (memcmp(suite_name, tmp_suite_name, suite_name_len) == 0) {
<a name="l00146"></a>00146                                         <span class="keywordflow">return</span> 1;
<a name="l00147"></a>00147                                 }                       
<a name="l00148"></a>00148                         }
<a name="l00149"></a>00149                 }
<a name="l00150"></a>00150 
<a name="l00151"></a>00151         }
<a name="l00152"></a>00152 
<a name="l00153"></a>00153         <span class="keywordflow">return</span> 0;
<a name="l00154"></a>00154 }
<a name="l00155"></a>00155 
<a name="l00156"></a>00156 <span class="comment">/* do we run the given test, given the current command line */</span>
<a name="l00157"></a><a class="code" href="a00007.html#a2578781a977cfd9eeb86039c8818a42c">00157</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="a00007.html#a2578781a977cfd9eeb86039c8818a42c">VTEST_is_run_test</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *suite_name, <span class="keyword">const</span> <span class="keywordtype">char</span> *test_name,  <span class="keywordtype">char</span> *argv[],<span class="keywordtype">int</span> argc)
<a name="l00158"></a>00158 {
<a name="l00159"></a>00159         <span class="keywordtype">char</span> *last_pos, *tstname, *tmp_suite_name;
<a name="l00160"></a>00160         <span class="keywordtype">int</span> tstlen, i, is_suite, suite_name_len, test_count;
<a name="l00161"></a>00161 
<a name="l00162"></a>00162         <span class="keywordflow">if</span> (!argv || !argc) {
<a name="l00163"></a>00163                 <span class="keywordflow">return</span> 1;
<a name="l00164"></a>00164         }
<a name="l00165"></a>00165 
<a name="l00166"></a>00166         <span class="keywordflow">for</span>(i = 0; i &lt; argc; i++) {
<a name="l00167"></a>00167 
<a name="l00168"></a>00168                 is_suite = 0;
<a name="l00169"></a>00169                 <span class="keywordflow">if</span> (<a class="code" href="a00007.html#a1513dea154603f49cb0d46e50659602b">parse_suite_name</a>(argv[i],&amp;tmp_suite_name, &amp;suite_name_len)) {
<a name="l00170"></a>00170                         <span class="keywordflow">if</span> (strlen(suite_name) == (<span class="keywordtype">size_t</span>) suite_name_len) {
<a name="l00171"></a>00171                                 <span class="keywordflow">if</span> (memcmp(suite_name, tmp_suite_name, suite_name_len) == 0) {
<a name="l00172"></a>00172                                         is_suite = 1;
<a name="l00173"></a>00173                                 }                       
<a name="l00174"></a>00174                         }
<a name="l00175"></a>00175                 }
<a name="l00176"></a>00176 
<a name="l00177"></a>00177                 <span class="keywordflow">if</span> (!is_suite) {
<a name="l00178"></a>00178                         <span class="keywordflow">continue</span>;
<a name="l00179"></a>00179                 }
<a name="l00180"></a>00180 
<a name="l00181"></a>00181                 <span class="keywordflow">for</span>( test_count = 0, last_pos = 0; <a class="code" href="a00007.html#adfa4d68daca4820097c72d87bb3c0bc0">parse_next_test_name</a>(argv[i],&amp;tstname,&amp;tstlen,&amp;last_pos); test_count += 1 ) {
<a name="l00182"></a>00182                         <span class="keywordflow">if</span> (strlen(test_name) == (size_t) tstlen) {
<a name="l00183"></a>00183                                 <span class="keywordflow">if</span> (memcmp(test_name, tstname, tstlen) == 0) {
<a name="l00184"></a>00184                                         <span class="keywordflow">return</span> 1;
<a name="l00185"></a>00185                                 }
<a name="l00186"></a>00186                         }
<a name="l00187"></a>00187                 }
<a name="l00188"></a>00188 
<a name="l00189"></a>00189                 <span class="keywordflow">if</span> (!test_count) {
<a name="l00190"></a>00190                         <span class="keywordflow">return</span> 1;
<a name="l00191"></a>00191                 }
<a name="l00192"></a>00192         
<a name="l00193"></a>00193         }
<a name="l00194"></a>00194         <span class="keywordflow">return</span> 0;
<a name="l00195"></a>00195 }
<a name="l00196"></a>00196 
<a name="l00197"></a>00197 
<a name="l00198"></a>00198 
<a name="l00199"></a><a class="code" href="a00010.html#aafd1fce2122fb39ccbc0afb612c59be3">00199</a> <span class="keywordtype">void</span> <a class="code" href="a00007.html#aafd1fce2122fb39ccbc0afb612c59be3">VTEST_goto_next_suite</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *suite_name)
<a name="l00200"></a>00200 {
<a name="l00201"></a>00201         <span class="keywordflow">if</span> (suite_name) {
<a name="l00202"></a>00202                 <a class="code" href="a00007.html#a1fab7003576575cdfd86da7a19ae87a2">g_suite_name</a> = strdup(suite_name);
<a name="l00203"></a>00203         }
<a name="l00204"></a>00204 }
<a name="l00205"></a>00205 
<a name="l00206"></a><a class="code" href="a00007.html#a526d7e5ae684f37a5eecacf20fcba6a5">00206</a> <span class="keyword">static</span> <a class="code" href="a00004.html">VTEST_TEST_SUITE</a> *<a class="code" href="a00007.html#a526d7e5ae684f37a5eecacf20fcba6a5">find_suite_by_name</a>(<a class="code" href="a00004.html">VTEST_TEST_SUITE</a> *first_suite, <span class="keyword">const</span> <span class="keywordtype">char</span> *suite_name)
<a name="l00207"></a>00207 {
<a name="l00208"></a>00208 
<a name="l00209"></a>00209         <span class="keywordflow">for</span>( ;first_suite; first_suite = first_suite-&gt;<a class="code" href="a00004.html#a56e5e719928172615641f316d5144401">next_suite</a> ) {
<a name="l00210"></a>00210 
<a name="l00211"></a>00211                 <span class="keywordflow">if</span> (strcmp( first_suite-&gt;<a class="code" href="a00004.html#a606e0fc75c44a092aeb4ce79dc66da4c">name</a>, suite_name) == 0) {
<a name="l00212"></a>00212                         <span class="keywordflow">return</span> first_suite;
<a name="l00213"></a>00213                 }
<a name="l00214"></a>00214         }
<a name="l00215"></a>00215         <span class="keywordflow">return</span> 0;
<a name="l00216"></a>00216 }
<a name="l00217"></a>00217 
<a name="l00218"></a><a class="code" href="a00007.html#ae3e2f7b5d5cc123773ac1f3c99fe8d14">00218</a> <span class="preprocessor">#define timerclear_timeval(tvp)         ((tvp)-&gt;tv_sec = (tvp)-&gt;tv_usec = 0)</span>
<a name="l00219"></a>00219 <span class="preprocessor"></span>
<a name="l00220"></a><a class="code" href="a00007.html#aa27119f0dfe5abbd5fcb21a0bdca24d8">00220</a> <span class="preprocessor">#define timersub_timeval(a, b, result)                                                \</span>
<a name="l00221"></a>00221 <span class="preprocessor">  do {                                                                        \</span>
<a name="l00222"></a>00222 <span class="preprocessor">    (result)-&gt;tv_sec = (a)-&gt;tv_sec - (b)-&gt;tv_sec;                             \</span>
<a name="l00223"></a>00223 <span class="preprocessor">    (result)-&gt;tv_usec = (a)-&gt;tv_usec - (b)-&gt;tv_usec;                          \</span>
<a name="l00224"></a>00224 <span class="preprocessor">    if ((result)-&gt;tv_usec &lt; 0) {                                              \</span>
<a name="l00225"></a>00225 <span class="preprocessor">      --(result)-&gt;tv_sec;                                                     \</span>
<a name="l00226"></a>00226 <span class="preprocessor">      (result)-&gt;tv_usec += 1000000;                                           \</span>
<a name="l00227"></a>00227 <span class="preprocessor">    }                                                                         \</span>
<a name="l00228"></a>00228 <span class="preprocessor">  } while (0)</span>
<a name="l00229"></a>00229 <span class="preprocessor"></span>
<a name="l00230"></a><a class="code" href="a00007.html#a25765cd5bcf3020fd22b203cf6506469">00230</a> <span class="preprocessor">#define timeradd_timeval(a, b, result)                                                \</span>
<a name="l00231"></a>00231 <span class="preprocessor">  do {                                                                        \</span>
<a name="l00232"></a>00232 <span class="preprocessor">    (result)-&gt;tv_sec = (a)-&gt;tv_sec + (b)-&gt;tv_sec;                             \</span>
<a name="l00233"></a>00233 <span class="preprocessor">    (result)-&gt;tv_usec = (a)-&gt;tv_usec + (b)-&gt;tv_usec;                          \</span>
<a name="l00234"></a>00234 <span class="preprocessor">    if ((result)-&gt;tv_usec &gt;= 1000000)                                         \</span>
<a name="l00235"></a>00235 <span class="preprocessor">      {                                                                       \</span>
<a name="l00236"></a>00236 <span class="preprocessor">        ++(result)-&gt;tv_sec;                                                   \</span>
<a name="l00237"></a>00237 <span class="preprocessor">        (result)-&gt;tv_usec -= 1000000;                                         \</span>
<a name="l00238"></a>00238 <span class="preprocessor">      }                                                                       \</span>
<a name="l00239"></a>00239 <span class="preprocessor">  } while (0)</span>
<a name="l00240"></a>00240 <span class="preprocessor"></span>
<a name="l00241"></a>00241 
<a name="l00242"></a><a class="code" href="a00010.html#aa917b1c203ce5d52b924f3369956df93">00242</a> <span class="keywordtype">int</span> <a class="code" href="a00007.html#aa917b1c203ce5d52b924f3369956df93" title="run selected list of suites and tests; selection is specified via command line">VTEST_test_runner_cmdline</a>(<a class="code" href="a00004.html">VTEST_TEST_SUITE</a> *suite, <a class="code" href="a00002.html">VTEST_RUNNER_IMPL</a> *impl, <span class="keywordtype">int</span> argc,  <span class="keywordtype">char</span> *argv[])
<a name="l00243"></a>00243 {
<a name="l00244"></a>00244         <span class="keywordtype">int</span> testsfailed = 0;
<a name="l00245"></a>00245         <span class="keywordtype">int</span> testspassed = 0;
<a name="l00246"></a>00246         <span class="keywordtype">int</span> testnotrun  = 0;
<a name="l00247"></a>00247         <span class="keywordtype">int</span> suitesinitfailed = 0;
<a name="l00248"></a>00248         <span class="keywordtype">int</span> suitesteardownfailed = 0;
<a name="l00249"></a>00249         <a class="code" href="a00004.html">VTEST_TEST_SUITE</a> *first_suite = suite;
<a name="l00250"></a>00250 <span class="preprocessor">#ifdef TIME_TEST_GETTIMEOFDAY</span>
<a name="l00251"></a>00251 <span class="preprocessor"></span>        <span class="keyword">struct </span>timeval start, end, duration;
<a name="l00252"></a>00252 <span class="preprocessor">#endif</span>
<a name="l00253"></a>00253 <span class="preprocessor"></span>
<a name="l00254"></a>00254 
<a name="l00255"></a>00255 
<a name="l00256"></a>00256         <span class="keywordtype">int</span> i,suite_ok;
<a name="l00257"></a>00257 
<a name="l00258"></a>00258         vtest_impl = impl;
<a name="l00259"></a>00259 
<a name="l00260"></a>00260         <span class="keywordflow">for</span>(;suite; suite = suite-&gt;<a class="code" href="a00004.html#a56e5e719928172615641f316d5144401">next_suite</a>) {
<a name="l00261"></a>00261                 <a class="code" href="a00003.html">VTEST_TEST</a> *test;
<a name="l00262"></a>00262 
<a name="l00263"></a>00263                 <span class="keywordflow">if</span> (<a class="code" href="a00007.html#a1fab7003576575cdfd86da7a19ae87a2">g_suite_name</a>) {
<a name="l00264"></a>00264                         <a class="code" href="a00004.html">VTEST_TEST_SUITE</a> *next;
<a name="l00265"></a>00265 
<a name="l00266"></a>00266                         next = <a class="code" href="a00007.html#a526d7e5ae684f37a5eecacf20fcba6a5">find_suite_by_name</a>(first_suite, <a class="code" href="a00007.html#a1fab7003576575cdfd86da7a19ae87a2">g_suite_name</a>);
<a name="l00267"></a>00267                         free(<a class="code" href="a00007.html#a1fab7003576575cdfd86da7a19ae87a2">g_suite_name</a>);
<a name="l00268"></a>00268                         <a class="code" href="a00007.html#a1fab7003576575cdfd86da7a19ae87a2">g_suite_name</a> = 0;
<a name="l00269"></a>00269                         
<a name="l00270"></a>00270                         <span class="keywordflow">if</span> (next) {
<a name="l00271"></a>00271                                 suite = next;
<a name="l00272"></a>00272                         }                       
<a name="l00273"></a>00273                 }
<a name="l00274"></a>00274 
<a name="l00275"></a>00275                 vtest_impl-&gt;<a class="code" href="a00002.html#a82335d40bafedf6ed3df5bb2c2ca63a7">suite</a> = suite;
<a name="l00276"></a>00276                 vtest_impl-&gt;<a class="code" href="a00002.html#ad9a7903a319ed14b62fb2de303e6f5b9">test</a> = 0;
<a name="l00277"></a>00277 
<a name="l00278"></a>00278 
<a name="l00279"></a>00279                 <span class="keywordflow">if</span> (!<a class="code" href="a00007.html#ab8c1dd9c6da0bf795cc70a1feeef6292">VTEST_is_run_suite</a>(suite-&gt;<a class="code" href="a00004.html#a606e0fc75c44a092aeb4ce79dc66da4c">name</a>, argv, argc)) {
<a name="l00280"></a>00280                         <span class="keywordflow">continue</span>;
<a name="l00281"></a>00281                 }
<a name="l00282"></a>00282 
<a name="l00283"></a>00283                 <span class="keywordflow">if</span> (impl-&gt;<a class="code" href="a00002.html#a84275152b2efc400e37d05a3e2cae229">suite_start</a>) {
<a name="l00284"></a>00284                   impl-&gt;<a class="code" href="a00002.html#a84275152b2efc400e37d05a3e2cae229">suite_start</a>(suite-&gt;<a class="code" href="a00004.html#a606e0fc75c44a092aeb4ce79dc66da4c">name</a>);
<a name="l00285"></a>00285                 }
<a name="l00286"></a>00286 
<a name="l00287"></a>00287                 suite_ok = 1;
<a name="l00288"></a>00288 
<a name="l00289"></a>00289 <span class="preprocessor">#if 0</span>
<a name="l00290"></a>00290 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (suite-&gt;<a class="code" href="a00004.html#a73c6b953e3b1c5f39b34d02ae9b693ee">setUp</a>) {
<a name="l00291"></a>00291                         
<a name="l00292"></a>00292                         vtest_impl-&gt;<a class="code" href="a00002.html#a85901f9cda6b2b7ce0a101cda31d9974">current_test_state</a> = 1; 
<a name="l00293"></a>00293                         vtest_impl-&gt;<a class="code" href="a00002.html#a90804fc11deef7b08763e47e01a9e6d2">scope_fail</a> = <a class="code" href="a00010.html#a8e1ed97b5fce3b7a10ab01d202fdc8c1a41eb9054c64f8662bd8303e861a1c986">VTEST_SUITE_SETUP_FAILED</a>;
<a name="l00294"></a>00294 
<a name="l00295"></a>00295                         suite-&gt;<a class="code" href="a00004.html#a73c6b953e3b1c5f39b34d02ae9b693ee">setUp</a>();
<a name="l00296"></a>00296 
<a name="l00297"></a>00297                         <span class="keywordflow">if</span> (!vtest_impl-&gt;<a class="code" href="a00002.html#a85901f9cda6b2b7ce0a101cda31d9974">current_test_state</a>) {
<a name="l00298"></a>00298                                 suite_ok = 0;   
<a name="l00299"></a>00299                         }
<a name="l00300"></a>00300                 }
<a name="l00301"></a>00301 <span class="preprocessor">#endif</span>
<a name="l00302"></a>00302 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (suite_ok)  {
<a name="l00303"></a>00303 
<a name="l00304"></a>00304                         vtest_impl-&gt;<a class="code" href="a00002.html#a2242678dd75ca03df88bb28f311ea17a">results</a>( <a class="code" href="a00010.html#a8e1ed97b5fce3b7a10ab01d202fdc8c1a5e7abc933e42bb5da70c90612652a8cc">VTEST_SUITE_SETUP_OK</a>, suite-&gt;<a class="code" href="a00004.html#a606e0fc75c44a092aeb4ce79dc66da4c">name</a>, 0, 0, 0, 0, 0);
<a name="l00305"></a>00305                 
<a name="l00306"></a>00306                         <span class="keywordflow">for</span>(test = suite-&gt;<a class="code" href="a00004.html#ae6efa9c269cc192393aa2dfd3ce83d38">test_cases</a>; test-&gt;<a class="code" href="a00003.html#aedbd326bc39dd559d329cb4610da93d4">name</a> != 0; test++) {
<a name="l00307"></a>00307 
<a name="l00308"></a>00308                            <span class="keywordflow">if</span> (!<a class="code" href="a00007.html#a2578781a977cfd9eeb86039c8818a42c">VTEST_is_run_test</a>(suite-&gt;<a class="code" href="a00004.html#a606e0fc75c44a092aeb4ce79dc66da4c">name</a>, test-&gt;<a class="code" href="a00003.html#aedbd326bc39dd559d329cb4610da93d4">name</a>, argv, argc)) {
<a name="l00309"></a>00309                                 <span class="keywordflow">continue</span>;
<a name="l00310"></a>00310                            }
<a name="l00311"></a>00311 
<a name="l00312"></a>00312 
<a name="l00313"></a>00313                            vtest_impl-&gt;<a class="code" href="a00002.html#ad9a7903a319ed14b62fb2de303e6f5b9">test</a> = test;
<a name="l00314"></a>00314 
<a name="l00315"></a>00315 
<a name="l00316"></a>00316                                 
<a name="l00317"></a>00317                            <span class="keywordflow">for</span>(i = 0; i &lt; test-&gt;<a class="code" href="a00003.html#ae67a002d03792b660e181c0d370e6ea3">repeat</a> <span class="comment">/*&amp;&amp; !g_suite_name*/</span> ; i++) {
<a name="l00318"></a>00318 
<a name="l00319"></a>00319                                    impl-&gt;<a class="code" href="a00002.html#a2d98ba63d74c6cfab28598a800985d46">test_start</a>( suite-&gt;<a class="code" href="a00004.html#a606e0fc75c44a092aeb4ce79dc66da4c">name</a>, test-&gt;<a class="code" href="a00003.html#aedbd326bc39dd559d329cb4610da93d4">name</a>, i+1, test-&gt;<a class="code" href="a00003.html#ae67a002d03792b660e181c0d370e6ea3">repeat</a>);
<a name="l00320"></a>00320 
<a name="l00321"></a>00321                                    vtest_impl-&gt;<a class="code" href="a00002.html#a85901f9cda6b2b7ce0a101cda31d9974">current_test_state</a> = 1; 
<a name="l00322"></a>00322 
<a name="l00323"></a>00323 
<a name="l00324"></a>00324 <span class="preprocessor">#ifdef TIME_TEST_GETTIMEOFDAY</span>
<a name="l00325"></a>00325 <span class="preprocessor"></span>                                   gettimeofday( &amp;start, 0 );
<a name="l00326"></a>00326 <span class="preprocessor">#endif</span>
<a name="l00327"></a>00327 <span class="preprocessor"></span>                                   
<a name="l00328"></a>00328                                    <span class="keywordflow">if</span> (suite-&gt;<a class="code" href="a00004.html#a73c6b953e3b1c5f39b34d02ae9b693ee">setUp</a>) {
<a name="l00329"></a>00329                                         vtest_impl-&gt;<a class="code" href="a00002.html#a90804fc11deef7b08763e47e01a9e6d2">scope_fail</a> = <a class="code" href="a00010.html#a8e1ed97b5fce3b7a10ab01d202fdc8c1a41eb9054c64f8662bd8303e861a1c986">VTEST_SUITE_SETUP_FAILED</a>;
<a name="l00330"></a>00330                                         suite-&gt;<a class="code" href="a00004.html#a73c6b953e3b1c5f39b34d02ae9b693ee">setUp</a>();
<a name="l00331"></a>00331                                    
<a name="l00332"></a>00332                                    }
<a name="l00333"></a>00333 
<a name="l00334"></a>00334                                    <span class="keywordflow">if</span> (vtest_impl-&gt;<a class="code" href="a00002.html#a85901f9cda6b2b7ce0a101cda31d9974">current_test_state</a>) {
<a name="l00335"></a>00335                                      vtest_impl-&gt;<a class="code" href="a00002.html#a90804fc11deef7b08763e47e01a9e6d2">scope_fail</a> = <a class="code" href="a00010.html#a8e1ed97b5fce3b7a10ab01d202fdc8c1a1c90df150f8ebaf0848650618c66bec7">VTEST_TEST_FAILED</a>;
<a name="l00336"></a>00336                                      test-&gt;<a class="code" href="a00003.html#aab90c5c247a2c1db1b525927425466c6">function</a>();
<a name="l00337"></a>00337                                    }
<a name="l00338"></a>00338 
<a name="l00339"></a>00339 
<a name="l00340"></a>00340                                    <span class="keywordflow">if</span> (vtest_impl-&gt;<a class="code" href="a00002.html#a85901f9cda6b2b7ce0a101cda31d9974">current_test_state</a> &amp;&amp; suite-&gt;<a class="code" href="a00004.html#a4963995b80ce16dd826c2e9db46be15a">tearDown</a>) {
<a name="l00341"></a>00341                                         vtest_impl-&gt;<a class="code" href="a00002.html#a90804fc11deef7b08763e47e01a9e6d2">scope_fail</a> = <a class="code" href="a00010.html#a8e1ed97b5fce3b7a10ab01d202fdc8c1aead358466757d63f9ff64e91099729c6">VTEST_SUITE_TEARDOWN_FAILED</a>;
<a name="l00342"></a>00342                                         suite-&gt;<a class="code" href="a00004.html#a4963995b80ce16dd826c2e9db46be15a">tearDown</a>();
<a name="l00343"></a>00343                                    }
<a name="l00344"></a>00344 
<a name="l00345"></a>00345 
<a name="l00346"></a>00346                                    <span class="keywordflow">if</span> (vtest_impl-&gt;<a class="code" href="a00002.html#a85901f9cda6b2b7ce0a101cda31d9974">current_test_state</a>) {
<a name="l00347"></a>00347 <span class="preprocessor">#ifdef TIME_TEST_GETTIMEOFDAY</span>
<a name="l00348"></a>00348 <span class="preprocessor"></span>                                          gettimeofday( &amp;end, 0 );
<a name="l00349"></a>00349                                           <a class="code" href="a00007.html#aa27119f0dfe5abbd5fcb21a0bdca24d8">timersub_timeval</a>( &amp;end, &amp;start, &amp;duration );
<a name="l00350"></a>00350 
<a name="l00351"></a>00351                                           vtest_impl-&gt;<a class="code" href="a00002.html#a2242678dd75ca03df88bb28f311ea17a">results</a>( <a class="code" href="a00010.html#a8e1ed97b5fce3b7a10ab01d202fdc8c1a707418bf7b2400b7282f16af32769069">VTEST_TEST_OK</a>, 
<a name="l00352"></a>00352                                                                         vtest_impl-&gt;<a class="code" href="a00002.html#a82335d40bafedf6ed3df5bb2c2ca63a7">suite</a>-&gt;<a class="code" href="a00004.html#a606e0fc75c44a092aeb4ce79dc66da4c">name</a>, 
<a name="l00353"></a>00353                                                                         vtest_impl-&gt;<a class="code" href="a00002.html#ad9a7903a319ed14b62fb2de303e6f5b9">test</a>-&gt;<a class="code" href="a00003.html#aedbd326bc39dd559d329cb4610da93d4">name</a>, 
<a name="l00354"></a>00354                                                                         &amp;duration,
<a name="l00355"></a>00355                                                                         0, 0, 0);
<a name="l00356"></a>00356 <span class="preprocessor">#else</span>
<a name="l00357"></a>00357 <span class="preprocessor"></span>                                          vtest_impl-&gt;<a class="code" href="a00002.html#a2242678dd75ca03df88bb28f311ea17a">results</a>( <a class="code" href="a00010.html#a8e1ed97b5fce3b7a10ab01d202fdc8c1a707418bf7b2400b7282f16af32769069">VTEST_TEST_OK</a>,
<a name="l00358"></a>00358                                                                         vtest_impl-&gt;<a class="code" href="a00002.html#a82335d40bafedf6ed3df5bb2c2ca63a7">suite</a>-&gt;<a class="code" href="a00004.html#a606e0fc75c44a092aeb4ce79dc66da4c">name</a>, 
<a name="l00359"></a>00359                                                                         vtest_impl-&gt;<a class="code" href="a00002.html#ad9a7903a319ed14b62fb2de303e6f5b9">test</a>-&gt;<a class="code" href="a00003.html#aedbd326bc39dd559d329cb4610da93d4">name</a>, 
<a name="l00360"></a>00360                                                                         0,
<a name="l00361"></a>00361                                                                         0, 0, 0);
<a name="l00362"></a>00362 <span class="preprocessor">#endif                             </span>
<a name="l00363"></a>00363 <span class="preprocessor"></span>                                   }
<a name="l00364"></a>00364                                    <span class="keywordflow">if</span> (vtest_impl-&gt;<a class="code" href="a00002.html#a85901f9cda6b2b7ce0a101cda31d9974">current_test_state</a>) {
<a name="l00365"></a>00365                                            testspassed++;
<a name="l00366"></a>00366                                    } <span class="keywordflow">else</span> {
<a name="l00367"></a>00367                                            testsfailed++;
<a name="l00368"></a>00368                                    }
<a name="l00369"></a>00369                            } <span class="comment">// eof test</span>
<a name="l00370"></a>00370                            
<a name="l00371"></a>00371                         } <span class="comment">// eof suite</span>
<a name="l00372"></a>00372 
<a name="l00373"></a>00373 <span class="preprocessor">#if 0</span>
<a name="l00374"></a>00374 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (suite-&gt;<a class="code" href="a00004.html#a4963995b80ce16dd826c2e9db46be15a">tearDown</a>) {
<a name="l00375"></a>00375 
<a name="l00376"></a>00376                                 vtest_impl-&gt;<a class="code" href="a00002.html#a85901f9cda6b2b7ce0a101cda31d9974">current_test_state</a> = 1; 
<a name="l00377"></a>00377                                 vtest_impl-&gt;<a class="code" href="a00002.html#a90804fc11deef7b08763e47e01a9e6d2">scope_fail</a> = <a class="code" href="a00010.html#a8e1ed97b5fce3b7a10ab01d202fdc8c1aead358466757d63f9ff64e91099729c6">VTEST_SUITE_TEARDOWN_FAILED</a>;
<a name="l00378"></a>00378                                 vtest_impl-&gt;<a class="code" href="a00002.html#ad9a7903a319ed14b62fb2de303e6f5b9">test</a> = 0;
<a name="l00379"></a>00379 
<a name="l00380"></a>00380                                 suite-&gt;<a class="code" href="a00004.html#a4963995b80ce16dd826c2e9db46be15a">tearDown</a>();
<a name="l00381"></a>00381 
<a name="l00382"></a>00382                         
<a name="l00383"></a>00383                                 <span class="keywordflow">if</span> (vtest_impl-&gt;<a class="code" href="a00002.html#a85901f9cda6b2b7ce0a101cda31d9974">current_test_state</a>) {
<a name="l00384"></a>00384                                         vtest_impl-&gt;<a class="code" href="a00002.html#a2242678dd75ca03df88bb28f311ea17a">results</a>( <a class="code" href="a00010.html#a8e1ed97b5fce3b7a10ab01d202fdc8c1ac1a892989da91fd3d362008c3cd12f69">VTEST_SUITE_TEARDOWN_OK</a>, suite-&gt;<a class="code" href="a00004.html#a606e0fc75c44a092aeb4ce79dc66da4c">name</a>, 0, 0, 0, 0);
<a name="l00385"></a>00385                                         
<a name="l00386"></a>00386                                 } <span class="keywordflow">else</span> {
<a name="l00387"></a>00387                                         suitesteardownfailed++;
<a name="l00388"></a>00388                                 }
<a name="l00389"></a>00389                         }
<a name="l00390"></a>00390 <span class="preprocessor">#endif</span>
<a name="l00391"></a>00391 <span class="preprocessor"></span>                } <span class="keywordflow">else</span> {
<a name="l00392"></a>00392                         <span class="comment">/*test setup failed*/</span>
<a name="l00393"></a>00393                         <span class="keywordflow">for</span>(test = suite-&gt;<a class="code" href="a00004.html#ae6efa9c269cc192393aa2dfd3ce83d38">test_cases</a>;test-&gt;<a class="code" href="a00003.html#aedbd326bc39dd559d329cb4610da93d4">name</a> != 0;test++) {
<a name="l00394"></a>00394                                 testnotrun ++;
<a name="l00395"></a>00395                         }
<a name="l00396"></a>00396                         suitesinitfailed ++;
<a name="l00397"></a>00397                 }
<a name="l00398"></a>00398                 
<a name="l00399"></a>00399         }
<a name="l00400"></a>00400 
<a name="l00401"></a>00401         vtest_impl-&gt;<a class="code" href="a00002.html#a1363985c7632864c794d5366453becc2">wrapup</a>( suitesinitfailed, suitesteardownfailed,
<a name="l00402"></a>00402                                             testspassed, testsfailed, testnotrun);
<a name="l00403"></a>00403 
<a name="l00404"></a>00404         <span class="keywordflow">return</span> suitesinitfailed == 0 &amp;&amp; suitesteardownfailed == 0 &amp;&amp; testspassed == 0 &amp;&amp; testsfailed == 0;
<a name="l00405"></a>00405 }
<a name="l00406"></a>00406 
<a name="l00407"></a>00407 
<a name="l00408"></a><a class="code" href="a00010.html#aa417fd7f65b276ab08060848510399b4">00408</a> <span class="keywordtype">int</span> <a class="code" href="a00007.html#aa417fd7f65b276ab08060848510399b4" title="run all test suites.">VTEST_test_runner</a>(<a class="code" href="a00004.html">VTEST_TEST_SUITE</a> *suite, <a class="code" href="a00002.html">VTEST_RUNNER_IMPL</a> *impl)
<a name="l00409"></a>00409 {
<a name="l00410"></a>00410         <span class="keywordflow">return</span> <a class="code" href="a00007.html#aa917b1c203ce5d52b924f3369956df93" title="run selected list of suites and tests; selection is specified via command line">VTEST_test_runner_cmdline</a>(suite, impl,0,0);
<a name="l00411"></a>00411 }
<a name="l00412"></a>00412 
<a name="l00413"></a>00413 
<a name="l00414"></a>00414 
<a name="l00415"></a>00415 
<a name="l00416"></a>00416 
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Wed Aug 31 2011 12:59:48 for Simple XUnit test library / objects in plain C by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </small></address>
</body>
</html>
