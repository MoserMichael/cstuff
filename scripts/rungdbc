#!/usr/bin/perl


if (scalar(@ARGV) == 0) {

print <<EOF
./rungdb <core file>
-------------------------------------------
Runs gdb with core file & process that created it.

EOF
;
exit(1);
}

$core_file = $ARGV[0];

$scr_file = "/tmp/gdb-src-$$.scr";


#
# Ask gdb to tell us the name of exe that did the core.
#

open(OFILE,">${scr_file}");
print OFILE <<EOF
core-file $core_file
quit
EOF
;

$fname = `gdb -x $scr_file | grep 'Core was generated by' | awk '{ print \$5 }'`;

if ($fname eq "") {
  print "not a core file";
  exit(1);
}

$fname = substr($fname,1);
chomp($fname);

#
# Ask gdb to open the exe with core and run bt.
#

close(OFILE);
open(OFILE,">${scr_file}");
print OFILE <<EOF
file $fname
core-file $core_file
bt 
EOF
;


system("gdb -x $scr_file");
unlink($scr_file);


