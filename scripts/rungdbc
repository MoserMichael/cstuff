#!/usr/bin/perl


if (scalar(@ARGV) == 0) {

print <<EOF
./rungdb <core file>
-------------------------------------------
Runs gdb with core file & process that created it.

EOF
;
exit(1);
}

$core_file = $ARGV[0];


if (! -f $core_file) {
  print "The core file $core file does not exist. very sorry.\n";
  exit(1);
}

#
# Ask gdb to tell us the name of exe that did the core.
#

$scr_file = "/tmp/gdb-src-$$.scr";

open(OFILE,">${scr_file}");
print OFILE <<EOF
core-file $core_file
quit
EOF
;

$fname = `gdb -x $scr_file | grep 'Core was generated by' | awk '{ print \$5 }'`;

if ($fname eq "") {
  print "not a core file";
  exit(1);
}

$fname = substr($fname,1);
chomp($fname);


if ( ! -f $fname ) {
  print <<EOF
The core file says that it has been generated by executable $fname, but 
no such executable has been found. This can be due to

  1) The executable was given via relative path, and the prcess changed its current directory. 
  2) The core file was moved from the place where it was generated.
  3) The executable got lost somehow.
  
EOF
;
  exit(1);
    
}

#
# Ask gdb to open the exe with core and run bt.
#

close(OFILE);
open(OFILE,">${scr_file}");
print OFILE <<EOF
file $fname
core-file $core_file
bt 
EOF
;


system("gdb -x $scr_file");
unlink($scr_file);


